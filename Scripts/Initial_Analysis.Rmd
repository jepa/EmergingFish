---
title: Matching the Time of Emergence of Transboundary Fish Stocks to Lead Time for
  Policy Response Under Climate Change
author: "Juliano Palacios Abrantes"
date: "09/03/2020"
output:
  word_document: default
  html_document: default
subtitle: Initital analysis
editor_options: 
  chunk_output_type: console
---


```{r Ch3_setup, eval = T, echo=F, warning=F,message=F, results='hide'}

#### READ ME !!! ####
# Run this chunk before knit so you make sure you have all pkgs installed in R

ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)) 
    install.packages(new.pkg, dependencies = TRUE,repos = "http://cran.us.r-project.org")
  sapply(pkg, require, character.only = TRUE)
}


#### Library ####
packages <- c(
  "tidyverse",
  "here", # for dbem_import `here()`
  "data.table", #dbem_import `fread()`
  "readxl", # for reading excell files
  "janitor", # for clearing names
  "geosphere", # estimate distances between points `distm()`
  "ggrepel",
  "zoo",
  "parallel" # for mclapply
)

ipak(packages)


# Set paths depending on machine Beast (jepa88), "carmelia" or Hall1000
if(Sys.info()[7] == "jepa88"){
  data_path <- "Z:/DATA/DBEM/"
}
if(Sys.info()[7] == "carmelia"){
  data_path <- paste(here(),"/Temporal_Data/",sep = "")
  DBEM_path <- paste(data_path,"DBEM/",sep="")
  result_path <- paste(here(),"/Temporal_Data/Results/",sep="")
}
if(Sys.info()[7] == "hall1000"){
  data_path <- "/Volumes/DATA/JULIANO_NEYMAR/TransEmergence/Data/"
  DBEM_path <- "/Volumes/DATA/DATA/DBEM/"
  result_path <- "/Volumes/DATA/JULIANO_NEYMAR/TransEmergence/Results/"
}


```


# Methods

### Fun `GetSppDist`

This function reads the DBEM data for each year and ensamble (ESM model) from 102 20 111


```{r GetSppDist, eval = T, echo = T}

dbem_import <- function(taxon_key, #Except taxon_key 
                        year, #Expects sequence of years 
                        ensamble, #Expects a number of the ensamble
                        data_type, #Expects either "Abd" or "Catch"
                        path = "NA"){
  

  years <- year_df %>% pull(year)
  
  D_Path <- paste(path,"mpa0F1ENS",ensamble,"/",taxon_key,"/",taxon_key,data_type,years,".txt",sep="")

  
  #### Importing data ####
  cur <- lapply(D_Path, FUN=fread, na.strings="NA")
  
  if(length(cur)>0){
    cur <- cur[sapply(cur, function(d) nrow(d) >= 1)] 
    colnames <- c("index", "value")
    cur <- lapply(cur, setNames, colnames)
    df <- bind_rows(cur, .id = "column_label")
    if(nrow(df)>0){
      frame_key <- tibble(column_label = seq(1,length(unlist(years)),1), 
                          "year"=years) %>% 
        mutate(column_label=as.character(column_label))
      df <- left_join(df, frame_key, by="column_label") %>% select(-column_label)
      df <- df %>% mutate(data_type=data_type,
                          taxon_key = taxon_key,
                          ensamble = ensamble
      )
    }
  } else {
    df <- tibble()
  }
    return(df)
} #Function end


# x <- dbem_import(
#   taxon_key <- 600004,
#   Year <- year_df,
#   data_type <- "Catch",
#   ensamble = 102,
#   # ensamble_list =ensamble,
#   path <- DBEM_path
# )


# attach(x)
# head(x)
# unique(year)
# unique(ensamble_list)
# detach(x)

```

## Proportion approach

### Fun `EstPropChange`

```{r EstPropChange, eval = T, echo = F}

EstPropChange <- function(taxon_key,
                          year,
                          data_type,
                          ensamble_list, # expects a list of ensambles to averrage by
                          path,
                          neighbours){
  
  
  # Loads species data for all ensambles
  spp_dist <- bind_rows(
    lapply(
      ensamble_list,
      dbem_import,
      taxon_key = taxon_key,
      year = year,
      data_type = data_type,
      path = path
    )
  )
  
  
  # head(spp_dist)
  
  # Result 1. Number of Countries that share the species
  
  suppressWarnings(
    trans_EEZ <- Transboundary_spp %>% 
      filter(taxon_key %in% spp_dist$taxon_key) %>% 
      left_join(Neighbours,
                by = c("eez_name","eez_neighbour")
      )
  )
  
  
  # List of indexes per EEZ
  index_id <- trans_EEZ %>% 
    group_by(eez_name,index) %>% 
    summarise(n=n()) %>% 
    select(-n)
  
  
  # --------------- #
  # Warning messages:
  # 1: Column `eez_name` joining factor and character vector, coercing into character vector 
  # 2: Column `eez_neighbour` joining factor and character vector, coercing into character vector 
  # --------------- #
  
  
  #____________ Selecting only the transboundary nature of the species _________ #
  trans_spp <- spp_dist %>%
    filter(index %in% trans_EEZ$index) %>% 
    left_join(index_id,
              by = "index")
  
  #____________ ESTIMATING DISTRIBUTION INDEX (TRESHOLD 3)_________ #
  # The number of species' cells present within each country's EEZ
  
  #Step 1.  Get EEZ id and Neighbour
  Neighbours_List <- Neighbours %>% 
    group_by(eez_name,eez_neighbour) %>% 
    summarise(n=n()) %>% 
    ungroup() %>% 
    select(-n) %>% 
    semi_join(trans_EEZ,
              by = c("eez_name","eez_neighbour")
    )
  
  # Step 2. Determines the amount of grids present in each country
  spp_grid <- trans_spp %>% 
    group_by(taxon_key,
             eez_name,
             year,
             ensamble) %>% 
    summarise(n_spp_eez = length(unique(index))) %>% 
    left_join(Neighbours_List,
              by = "eez_name")
  
  # Step 3. Sum total grids per Neighbours
  
  # Split dataframes to merge latter
  Territory_T <- spp_grid %>% 
    ungroup() %>% 
    select(
      taxon_key,
      Name=eez_name,
      n_spp_eez,
      year,
      ensamble
    )
  
  Neighbour_T <- spp_grid %>% 
    ungroup() %>% 
    select(
      taxon_key,
      n_spp_eez,
      Name=eez_neighbour,
      eez_name,
      year,
      ensamble
    )
  
  per_change_d <- full_join(Territory_T,
                            Neighbour_T, 
                            by = c("Name","taxon_key","year","ensamble")
  ) %>%
    rowwise() %>%
    mutate(Spp_Total = sum(n_spp_eez.x,n_spp_eez.y,na.rm=T)) %>% # Total gridcelles per Neighbours
    distinct() %>% # Removes false duplicates from `full_join()`
    rename(eez_name = Name,
           eez_neighbour =eez_name,
           n_spp_Country = n_spp_eez.x,
           n_spp_Neighbour = n_spp_eez.y) %>% 
    mutate(area_index = n_spp_Country/Spp_Total) %>% 
    # select(taxon_key,year,ensamble_list,eez_name,eez_neighbour,area_index) %>% 
    mutate(
      time_step = ifelse(year < 2000,"historical",
                         ifelse(year >= 2045 & year <= 2064, "mid",
                                ifelse(year >= 2080, "n_end","NA")
                         )
      )
    ) %>%
    filter(time_step != "NA") %>% 
    # Time mean and sd
    ungroup() %>% 
    group_by(taxon_key,ensamble,eez_name,eez_neighbour,time_step) %>% 
    summarise_at(vars("area_index"),
                 c(temporal_mean=mean,
                   temporal_sd=sd)
    ) %>% 
    # Ensamble mean and sd
    group_by(taxon_key,eez_name,eez_neighbour,time_step) %>%
    summarise_at(vars("temporal_mean"),
                 c(ensamble_mean=mean,
                   ensamble_sd=sd),
                 na.rm=T
    )
  
  # --------------- #
  # End function
  # --------------- #
  
  if(nrow(per_change_d) > 0){
  
  # Save Result
  name <- paste("proportion_",taxon_key,".csv",sep="")
  path_name <- paste(result_path,"Proportion/",name, sep="")
  
  write_csv(per_change_d,
            path_name)
  
  return(print(paste("analysis done",taxon_key)))
  
  }else{
    print(paste("no result for",taxon_key))
  }
  
  # Or return a df
  # return(per_change_d)
}

```

### Fun `EstTransIndex`

```{r funEstTransIndex, eval= F ,echo = T,warning = F,message = F}

# Function to determine whether or not a species is transboundary

# Varibales needed
# Spp: Species to be analized, data with presence/absence per gridcell
# Index_EEZ: Reference list of all INDEX that fall within EEZs
# EEZ_Size: Number of grid-cells that each EEZ has
# Neighbours: Reference list of neighbouring countries

# Needs getSppDist

#### For testing 
# Spp <- 600004  # Anchovie Equator, Chile and Peru
# Spp <- 600107 # Tuna Many RFMOs
# Spp <- 600004 # Argument 1 must have names (RFMO)
# Spp <- 600464 # Discrete species 
# Spp <- 600051 # One of Pierrs massive (wrong) discrete spp
# x <- c(600464, # Discreat spp in one nation
# 600059, # nowhere to be found spp
# 601352, # Discrete spp in two nations
# 600004) # transboundary spp
# Model <- "All"
# Coord <- CoorG
# 
# # For EEZ
# Neighbours <- Neighbours_Data
# Index_Code <- Index_Code

# __________________________________ #

# The function
EstTransIndex <- function(Spp,iyr,fyr,data_type,ensamble_list,Path,Neighbours){
  
  # Get model data from spps
  SppDist <- dbem_import(
    taxon_key = Spp,
    iyr <- iyr,
    fyr <- fyr,
    data_type <- "Abd",
    ensamble_list = ensamble_list,
    Path <- paste(data_path,"DBEM/",sep="")
  )
  
  # Result 1. Number of Countries that share the species
  
  #____________ Selecting only the transboundary nature of the species _________ #
  Trans_Spp <- SppDist %>%
    left_join(Neighbours,
              by= "index") %>% 
    filter(!is.na(value)) %>% 
    semi_join(Transboundary_spp, # filter only transboundary cases
              by = c("taxon_key","eez_name","eez_neighbour")
    )

  #____________ ESTIMATING DISTRIBUTION INDEX (TRESHOLD 3)_________ #
  # The number of species' cells present within each country's EEZ
  
  #Step 1.  Get EEZ id and Neighbour
  Neighbours_List <- Neighbours %>% 
    group_by(eez_name,eez_neighbour) %>% 
    summarise(n=n()) %>% 
    ungroup() %>% 
    select(-n)
  
  # Step 2. Determines the amount of grids present in each country
  Spp_Grid <- Trans_Spp %>% 
    group_by(taxon_key,
             eez_name,
             year,
             ensamble) %>% 
    summarise(n_spp_eez = length(unique(index))) %>% 
    left_join(Neighbours_List,
              by = "eez_name") %>% 
    filter(eez_name %in% Trans_Spp$eez_name, #Filter out unwanted Neighbours (those who don't have grids within but get included because they are Neighbours)
           eez_neighbour %in% Trans_Spp$eez_name)
  
  
  # Step 3. Sum total grids per Neighbours
  
      # Split dataframes to merge latter
    Territory_T <- Spp_Grid %>% 
      ungroup() %>% 
      select(
        taxon_key,
        Name=eez_name,
        n_spp_eez,
        year,
        ensamble
      )
    
    Neighbour_T <- Spp_Grid %>% 
      ungroup() %>% 
      select(
        taxon_key,
        n_spp_eez,
        Name=eez_neighbour,
        eez_name,
        year,
        ensamble
      )
    
    # Merge dataframes to get totals per Neighbourds
    area_index_d <- full_join(Territory_T,
                              Neighbour_T, 
                              by = c("Name","taxon_key","year","ensamble")
    ) %>%
      rowwise() %>%
      mutate(Spp_Total = sum(n_spp_eez.x,n_spp_eez.y,na.rm=T)) %>% # Total gridcelles per Neighbours
      distinct() %>% # Removes false duplicates from `full_join()`
      rename(eez_name = Name,
             eez_neighbour =eez_name,
             n_spp_Country = n_spp_eez.x,
             n_spp_Neighbour = n_spp_eez.y) %>% 
      mutate(area_index = n_spp_Country/Spp_Total) %>% 
      select(taxon_key,year,ensamble,eez_name,eez_neighbour,area_index) %>% 
      mutate(
        time_step = ifelse(year < 2000,"historical",
                           ifelse(year >= 2045 & year <= 2064, "mid",
                                  ifelse(year >= 2080, "n_end","NA")
                           )
        )
      ) %>%
      # Ensamble mean and sd
      ungroup() %>% 
      group_by(taxon_key,year,eez_name,eez_neighbour,time_step) %>% 
      summarise_at(vars("area_index"),
                   c(ensamble_mean=mean,
                     ensamble_sd=sd)
                   ) %>% 
      group_by(taxon_key,eez_name,eez_neighbour,time_step) %>% #Running mean
      mutate(RMean = rollmean(x = ensamble_mean,
                            5,
                            align = "right",
                            fill = ensamble_mean)
    )
    
    
    
  
    # Determine if changes
    natural_variation_d <- area_index_d %>% 
      ungroup() %>% #remove rowise
      filter(time_step == "historical") %>% 
      # Temporal mean
      group_by(taxon_key,eez_name,eez_neighbour) %>% 
      summarise_at(vars("ensamble_mean"),
                   c(hist_mean_index=mean,
                     hist_sd_index=sd)
      )


    ### Variation treshold
    variation_d <- area_index_d %>% 
      ungroup() %>% #remove rowise
      # Temporal mean
      group_by(taxon_key,time_step,eez_name,eez_neighbour) %>% 
      summarise_at(vars("RMean"),
                   c(mean_index=mean,
                     sd_index=sd)
      ) %>% 
      gather("variable","value",mean_index,sd_index) %>% 
      spread(time_step,value) %>% 
      mutate(larger_variation = ifelse(future > historical,"yes","no"))
      
    
    # William's index methodology
    trans_index_data <- area_index_d %>% 
      left_join(natural_variation_d,
                by = c("taxon_key","eez_name","eez_neighbour")) %>% 
      mutate(d_sd = ensamble_mean/sd_index) %>% 
      gather("variable","value",ensamble_mean:d_sd) %>% 
      ungroup() %>% 
      select(-time_step,-eez_neighbour) %>% 
      rowid_to_column() %>% 
      # spread(time_step,value) %>% 
      spread(eez_name,value) %>% 
      group_by(taxon_key,year,variable) %>% 
      summarise_at(vars("Chile","Ecuador","Peru"),
                   mean,na.rm=T)

    
    ggplot(area_index_d) +
      geom_ribbon(data=area_index_d,
                  aes(
                    x = as.numeric(year),
                    ymin=RMean-ensamble_sd,
                    ymax=RMean+ensamble_sd
                  ),
                  fill = "red",
                  alpha = 0.5
                  )+
      geom_line(
        aes(
          x = as.numeric(year),
          y = RMean
        )
      )  +
      facet_wrap(~eez_name + eez_neighbour,
                 scales = "free")
    
  
} # closes function

# __________________________________
# Test function
# __________________________________

```


### Fun `EstRangeIndex`

```{r load_data_per_ensamble, eval = F, echo = T}

#### Data needed (send to Control pannel latter)

# All ensambles
ensamble_list <- c(102,103)

# for dbem_impo_ensamble So we don't miss INDEX in different ensambles
world_grid <- tibble(index = seq(1,259200,1))
taxon_key <- 600005 #601477


# SAU relations between INDEX and Country's EEZs
EEZIDs_List <- read_excel(paste(data_path,"Spatial/V_Lam/Updated_EEZList_17June2016.xlsx",sep="")) %>% 
  clean_names()
EEZ_CellID <- read_excel(paste(data_path,"Spatial/V_Lam/EEZ_CellID.xlsx",sep="")) %>% 
  clean_names()
colnames(EEZ_CellID) <- c("eezid","index")

Lon_Lat_DBEM <- read.csv("~/GitHub/TransEmergence/Temporal_Data/Spatial/Lon_Lat_DBEM.txt", header=FALSE)
colnames(Lon_Lat_DBEM) <- c("index","lon","lat")

index_code <- EEZIDs_List %>% 
  left_join(EEZ_CellID) %>% 
  rename(eez_name = name) %>% 
  left_join(Lon_Lat_DBEM,
            by = "index")



EstRangeIndex <- function(taxon_key,iyr,fyr,ensamble_list){
  
  spp_data <- dbem_import(
    taxon_key = taxon_key,
    iyr <- 1951,
    fyr <- 2100,
    data_type <- "Abd",
    ensamble_list = ensamble_list,
    Path <- paste(data_path,"DBEM/",sep="")
  ) %>% 
    # Remove places where species is not destributed and set to cero differences between ensambles
    filter(!is.na(value)) %>% 
    spread(ensamble,value) %>% 
    gather(ensamble,value, -1:-3) %>% 
    mutate(value = ifelse(is.na(value),0,value)) %>% 
  # Include eez information
    left_join(index_code,
              by = "index") %>% 
    filter(!is.na(eezid))
  
  # Estimate mean eez centroid
  # centroid_data_eez <-  spp_data %>% 
  #   ungroup() %>% 
  #   group_by(taxon_key,ensamble,year,eezid,eez_name) %>% 
  #   top_n(1,value) %>% 
  #   group_by(year,taxon_key,ensamble,eezid,eez_name) %>% 
  #   summarise_at(vars(lon,lat),mean) %>%  # solves for multiple top 1
  #   rename(eez_centroid_lon = lon,
  #          eez_centroid_lat = lat) %>% 
  #   filter(!is.na(eezid))
  
  
  centroid_data_eez <-  spp_data %>% 
    ungroup() %>% 
    group_by(taxon_key,eezid,eez_name) %>%
    summarise_at(vars(lon,lat),mean) %>%  # solves for multiple top 1
    rename(eez_centroid_lon = lon,
           eez_centroid_lat = lat)
  
  # Visualization of  eez centroids
  # ggplot(spp_data) +
  #   geom_tile(
  #     aes(
  #     x = lon,
  #     y = lat,
  #     fill= eez_name
  #     )
  #   ) +
  #   geom_point(data = centroid_data_eez,
  #              aes(
  #                x = eez_centroid_lon,
  #                y = eez_centroid_lat,
  #                size = 1
  #              )
  #   )
  
  
# Estimate species distribution centroid
  centroid_spp <-  spp_data %>% 
    ungroup() %>% 
    group_by(taxon_key,ensamble,year) %>% 
    top_n(1,value) %>% 
    group_by(taxon_key,ensamble,year) %>% 
    summarise_at(vars(lon,lat),mean) %>%  # solves for multiple top 1
    rename(spp_centroid_lon = lon,
           spp_centroid_lat = lat)
  
  ggplot(centroid_spp) +
    geom_point(
      aes(
        x = spp_centroid_lon,
        y = spp_centroid_lat,
        size = as.numeric(year)#,
        # shape = eez_name
      )
    ) +
    geom_point(data = centroid_data_eez,
               aes(
                 x = eez_centroid_lon,
                 y = eez_centroid_lat,
                 color = eez_name
               )
    ) +
    facet_wrap(~ensamble)
  

# Estimate Transboundary Index
  trans_index_data <- centroid_data_eez %>% 
    left_join(centroid_spp,
              by = c("taxon_key") # removed year
              ) %>% 
    ungroup() %>% 
    # select(year,eez_name,ensamble,spp_centroid_lon,spp_centroid_lat,eez_centroid_lon, eez_centroid_lat) %>%
    rowwise() %>%
    mutate(d_eez = distm(c(eez_centroid_lon, eez_centroid_lat),c(spp_centroid_lon, spp_centroid_lat), fun = distHaversine))
    
trans_index_sd_data <- trans_index_data %>% 
  ungroup() %>% 
  filter(year <2000) %>% 
  group_by(eez_name,ensamble) %>% 
  summarise(
    s_sd = sd(d_eez)
  )

final_trans_index_data <- trans_index_data %>% 
  left_join(trans_index_sd_data,
            by = c("eez_name","ensamble")
            ) %>% 
  mutate(da_dsd = d_eez/s_sd) %>% 
  filter(eez_name != "Colombia (Pacific)") %>% 
  select(year,eez_name,ensamble,da_dsd) %>% 
  spread(eez_name,da_dsd) %>% 
  mutate(Trans_Index = `Mexico (Atlantic)`-`USA (Gulf of Mexico)`/2) %>% 
  ungroup() %>% 
  group_by(ensamble) %>% # Running mean as Kleisner & Pauly 2012
  mutate(RMean = rollmean(x = Trans_Index,
                            5,
                            align = "right",
                            fill = Trans_Index)
    )


ggplot(final_trans_index_data) +
  geom_line(
    aes(
      x = as.numeric(year),
      y = RMean,
      color = ensamble
    )
  ) +
  geom_line(data = final_trans_index_data,
    aes(
      x = as.numeric(year),
      y = Trans_Index,
      color = ensamble
    ),
    linetype = "dashed",
    alpha = 0.5
  ) +
  facet_wrap(~ensamble,
             ncol= 1)

  
  
  # %>% 
  #   filter(ensamble == 102) %>% 
  #   select(year,ensamble,eez_name,d_eez) %>% 
  #   spread(eez_name,d_eez) %>% 
  #   mutate()
  
  

  
  
  
  Year_MCP <-  spp_data %>% 
    # Aggregate MCP per EEZ
    group_by(taxon_key,eezid,eez_name,ensamble,year) %>% 
    summarise(eez_mcp = sum(value,na.rm=T)) %>% 
    # Ensamble mean
    group_by(taxon_key,eezid,eez_name,year) %>% 
    summarise(ensamble_mean = mean(eez_mcp,na.rm=T),
              ensamble_sd = sd(eez_mcp,na.rm=T)
              )
  
  # Test 
  # ggplot(spp_data) +
  #   geom_line(
  #     aes(
  #       x = as.numeric(year),
  #       y = ensamble_mean
  #     )
  #   ) +
  #   geom_point(
  #     aes(
  #       x = as.numeric(year),
  #       y = ensamble_mean+ensamble_sd
  #     )
  #   ) +
  #   geom_point(
  #     aes(
  #       x = as.numeric(year),
  #       y = ensamble_mean-ensamble_sd
  #     )
  #   ) +
  #   facet_wrap(~eez_name)
  
  
  
    
  } # close function

```

## Control Panel

```{r control_panel}

# Data needed for estimating Proportion change

year_df <- tibble(year =  c(seq(1995,2014,1), seq(2041,2060,1), seq(2080,2099,1)),
                  time_period = c(rep("Today", 20), rep("Mid Century", 20), rep("End of Century", 20))
                  )

data_type <- "Catch"
ensamble_list <- seq(102,103,1)
world_grid <- tibble(index = seq(1,259200,1))
Neighbours <- read_excel(paste(data_path,"Spatial/EEZ_Neighbour_List.xlsx",sep="")) %>% 
  clean_names()

Transboundary_spp <- read.csv(paste(data_path,"Species/Transboundary_spp.csv",sep="")) %>% clean_names()
  
spp_list <- unique(Transboundary_spp$taxon_key)[1:3]

```

## Proportion Routine

```{r Proportion_routine, eval = T, echo = F}
####_______________________ ####
# Estimating proportion change
####_______________________ ####

t_start <- Sys.time()

mclapply(
  spp_list, #c(600004,600005),
  EstPropChange,
  year <- year_df,
  data_type <- "Catch",
  ensamble_list = ensamble_list,
  path = DBEM_path,
  neighbours = Neighbours
)

t_end <- Sys.time()-t_start;t_end

```