---
title: Matching the Time of Emergence of Transboundary Fish Stocks to Lead Time for
  Policy Response Under Climate Change
author: "Juliano Palacios Abrantes"
date: "09/03/2020"
output:
  word_document: 
    keep_md: yes
  html_document: default
subtitle: Initital analysis
editor_options: 
  chunk_output_type: console
---


```{r setup, eval = T, echo = F, warning = F, message = F, results = 'hide'}

library(MyFunctions)

#### Project's Library
packages <- c(
  "dbemImport",
  "tidyverse",
  "here", # for dbem_import `here()`
  "data.table", #dbem_import `fread()`
  "readxl", # for reading excell files
  "janitor", # for clearing names
  "geosphere", # estimate distances between points `distm()`
  "ggrepel",
  "zoo", # for average mean
  "parallel", # for mclapply,
  "sf", # for mapping
  "st", # for mapping
  "rgdal", #Spatial analysis
  "tools", #Spatial analysis 
  "zeallot", # for Juanito's map
  "gmt", # for estimating distances between points
  "viridis",
  "cowplot",
  "rfishbase",
  "stargazer" # For nice lm tables
)

my_lib(packages)

```


# Methods

See methods section of the paper (e.g. Manusript.Rmd)

## Creating Data

Here we re-arrange existing data for the analysis. We have three steps:

1- Set the SAU relations between index and EEZs and include lat long data for each index

2.- Deteremine the centroid of each EEZ and asigned an id to each neighbouring interaction (e.g. Chile and Peru or Canada West Coast and US West Coast) 

3.- Set Neigbouring IDs based on the interactions between neighbouring EEZs for all of those sharing transboundary species

```{r pre_data_creation, eval = F, echo = F}

## ---------------##
#### 1. SAU relations between INDEX and Country's EEZs
# Re-ran with new names data
## ---------------##

# EEZIDs_List <- my_path("G", extra_path = "Spatial/V_Lam", name="Updated_EEZList_17June2016.xlsx", read = TRUE) %>%
  # clean_names()

EEZ_CellID <- my_path("G", extra_path = "Spatial/DBEM", name="EEZ_CellID.xlsx", read = TRUE) %>%
  clean_names()
colnames(EEZ_CellID) <- c("eezid","index")

# SAU name relatioal table (Fish For Visa)
sau_clean_names <- my_path("G", extra_path = "Spatial/SAU/", name="matching_names.csv", read = TRUE)

Lon_Lat_DBEM <- my_path("G", extra_path = "Spatial", name="Lon_Lat_DBEM.txt", read = TRUE, header = FALSE)
colnames(Lon_Lat_DBEM) <- c("index","lon","lat")


# Index_Code <- EEZIDs_List %>% 
#   left_join(EEZ_CellID) %>% 
#   rename(eez_name = name) %>% 
#   left_join(Lon_Lat_DBEM,
#             by = "index")


Index_Code <-  sau_clean_names %>% 
  select(eezid = sf_eezid) %>% 
  left_join(EEZ_CellID,
            by = "eezid") %>% 
  left_join(Lon_Lat_DBEM,
            by =  "index")

# Save Index data for future 
# write_csv(index_code,
          # paste(my_path("G",extra_path = "Spatial/DBEM"),"sau_index_code.csv",sep="")
          # )

## ---------------##
#### 2. entroids 
## ---------------##

# Load SAU shapefile name and paths

# The path
Path_SAU <- my_path("G", extra_path = "Spatial/SAU/SAU_Shapefile")

# The File
File_Name <- "SAUEEZ_July2015.shp"

# Load it!
SAU_eez_sf <- st_read(dsn = Path_SAU,
                        layer =file_path_sans_ext(File_Name)
                      ) %>% 
  rename(eez_name = Name) %>% 
  st_transform(crs = 4326) %>% # 4326
  st_simplify(preserveTopology = TRUE, dTolerance = 0.1)

# Get the center poligon of each EEZ for map source/target with st_centroid
coords <- as.data.frame(st_centroid(SAU_eez_sf)) %>% 
  ungroup() %>% 
  select(eez_name,geometry) %>% 
  separate(col = geometry, into = c("longitude", "latitude"), sep = "\\,") %>% 
  # Manually fix issues
  mutate(
    longitude = ifelse(
      eez_name == "Fiji", 178.065033,
      ifelse(eez_name == "Tuvalu",177.6493,
             ifelse( eez_name == "New Zealand",174.8860,
                     ifelse( eez_name == "USA (Alaska, Subarctic)",-145.8860,
                             ifelse( eez_name == "Brazil",-36.937,longitude
                             )
                     )
             )
      )
    )
  )

# Remove "c()"
coords$longitude <- gsub("\\(","",coords$longitude)
coords$longitude <- gsub("c","",coords$longitude)
coords$latitude <- gsub(")","",coords$latitude)

coords <- coords %>% 
  mutate_at(vars(longitude,latitude),as.numeric)

# Double check coords
# Note that Australia and Ggreenland have points in the middle of the country because of the EEZ shape

coords_map <- ggplot() +
  geom_sf(data = SAU_eez_sf, aes(), fill = NA) +
  geom_point(data = eez_centroid,
             aes(
               x = longitude,
               y = latitude
             )
  )

ggsave("coords_map.png",
       plot = coords_map,
       width = 10,
       height = 8,
       units = "in"
       )
  

# Save dataframe so we don't need to run this ewvery time
# write_csv(coords,
#           "eez_centroids.csv")


## ---------------##
#### 3. Set Neigbouring IDs
## ---------------##

# Read transboundary species database from Palacios-Abrantes et al 2020 (FishForVisa)
Transboundary_spp <- my_path("D", extra_path = "Species/", name="Transboundary_spp.csv", read = TRUE)

# Get id of neighbouring pairs
Neighbours_spp <- Transboundary_spp %>% 
  group_by(eez_name,eez_neighbour) %>% 
  summarise(n=n()) %>% 
  ungroup() %>% 
  select(-n) %>% 
  rownames_to_column("neighbour_id")

# Split dataframes to merge neighbouring ids
df1 <- Neighbours_spp
df2 <- Neighbours_spp
colnames(df2) <- c("neighbour_id", "eez_neighbour", "eez_name")

# Merge neighbouring ids
df_full <- bind_rows(df1, df2) %>% 
  group_by(eez_neighbour,eez_name) %>% 
  summarise(neighbour_id = min(neighbour_id))

# Save dataframe so we don't need to run this every time
# write_csv(df_full, 
#           "Neighbours_eez_id.csv")
    
```

## Estimating Proportion Change

This part of the analysis estimates the Stock Share Ratio and its change under cliamte change under two time frames; early (2030) and mid (2050). Note that 2020 is the average of 2021 to 2040 and mid is the average of 2041 to 2060.


### Fun `EstPropChange`

```{r EstPropChange, eval = T, echo = F}

EstPropChange <- function(taxon_key,
                          year,
                          hist_y = 2005,
                          data_type = "Catch",
                          ensemble_list, # expects a list of ensembles to averrage by
                          path,
                          neighbours){
  
  
  # Loads species data for all ensembles
  Spp_Dist <- bind_rows(
    lapply(
      ensemble_list,
      read_dbem_ens,
      taxon_key = taxon_key,
      year = year,
      data_type = data_type,
      model = "GFDL",
      rcp = "85",
      # path = "/Volumes/DATA/DATA",
      my_path = F
    )
  )
  

  # Filter Species distribution to that of the neighbouring EEZs
  # ------------ #
  # Warning message:
  # Column `eez_name` joining factor and character vector, coercing into character vector 
# ------------ #
  
  suppressWarnings(
    Trans_EEZ <- Transboundary_spp %>% 
      filter(taxon_key %in% Spp_Dist$taxon_key) %>% 
      left_join(index_code,
                by = c("eez_name")
      )
    )
  
  # Get neighbouring id
  Neighbours_List <- Neighbours %>% 
    semi_join(Trans_EEZ,
              by = c("eez_name","eez_neighbour")
    )
  
  # Selecting only the transboundary nature of the species
  Trans_Spp <- Spp_Dist %>%
    filter(index %in% Trans_EEZ$index) %>% 
    left_join(index_code,
              by = "index") %>% 
    filter(eez_name %in% Neighbours_List$eez_name)
  
  # -------------------- #
  # Estimate area index
  # The number of species' cells present within each country's EEZ
  # -------------------- #
  
  #Determines the amount of grids present in each country
  Spp_Grid <- Trans_Spp %>% 
    group_by(taxon_key,
             eez_name,
             year,
             ensemble) %>% 
    summarise(n_spp_eez = length(unique(index))) %>% 
    left_join(Neighbours_List,
              by = "eez_name")
  
  # Split dataframes to merge latter
  Territory_T <- Spp_Grid %>% 
    ungroup() %>% 
    select(
      taxon_key,
      Name=eez_name,
      n_spp_eez,
      year,
      ensemble
    )
  
  Neighbour_T <- Spp_Grid %>% 
    ungroup() %>% 
    select(
      taxon_key,
      n_spp_eez,
      Name=eez_neighbour,
      eez_name,
      year,
      ensemble
    )
  
  # Estimate Area index and % change
  Per_Ghange_D <- full_join(Territory_T,
                            Neighbour_T, 
                            by = c("Name","taxon_key","year","ensemble")
  ) %>%
    rowwise() %>%
    mutate(Spp_Total = sum(n_spp_eez.x,n_spp_eez.y,na.rm=T)) %>% # Total gridcelles per Neighbours
    distinct() %>% # Removes false duplicates from `full_join()`
    rename(eez_name = Name,
           eez_neighbour =eez_name,
           n_spp_Country = n_spp_eez.x,
           n_spp_Neighbour = n_spp_eez.y) %>% 
    mutate(area_index = n_spp_Country/Spp_Total) %>% 
    # Determine the three time frames for comparrison
    mutate(
      time_step = ifelse(year < hist_y,"historical",
                         ifelse(year >= 2021 & year <= 2040, "early",
                                ifelse(year >= 2041 & year <= 2060, "mid","NA")
                         )
      )
    ) %>%
    filter(time_step != "NA") %>% 
    # Time mean and sd
    ungroup() %>% 
    group_by(taxon_key,ensemble,eez_name,eez_neighbour,time_step) %>% 
    summarise_at(vars("area_index"),
                 c(temporal_mean=mean,
                   temporal_sd=sd)
    ) %>% 
    # ensemble mean and sd
    group_by(taxon_key,eez_name,eez_neighbour,time_step) %>%
    summarise(
      ensemble_mean = mean(temporal_mean, na.rm = T),
      ensemble_sd = sd(temporal_mean, na.rm = T),
      ensemble_n = n()
    )
  
  # --------------- #
  # End function
  # --------------- #
  
  if(nrow(Per_Ghange_D) > 0){
  
  # Save Result
  name <- paste("proportion_",taxon_key,".csv",sep="")
  path_name <- paste(my_path("R",extra_path = "Proportion_2005"),name,sep= "")
  
  write_csv(Per_Ghange_D,
            path_name)
  
  return(print(paste("analysis done",taxon_key)))
  # return(Per_Ghange_D)
  
  }else{
    print(paste("no result for",taxon_key))
  }
  
  # Or return a df
  # return(Per_Ghange_D)
}

# EstPropChange(taxon_key = 600004,
#               year = year_df$year,
#               hist_y = 2000,
#               data_type = "Catch",
#               ensemble_list = 102,
#               path = path,
#               neighbours = neighbours)
# 


```

### Proportion Control Panel

```{r Proportion_control_panel, eval = T, echo = F}

## ----------------- ##
# Data needed for estimating year of emergence
## ----------------- ##

# SAU relations between INDEX and Country's EEZs (see chunk 3)
index_code <- my_path("G", extra_path = "Spatial/SAU/", name="sau_index_code.csv", read = TRUE)

# Neighbour list and their respective id (see chunk 3)
Neighbours <- my_path("D", extra_path = "Spatial/", name="Neighbours_eez_id.csv", read = TRUE)

# Transboundary species and their sharing EEZs (see Palacios-Abrantes et al; FishForVisa)
Transboundary_spp <- my_path("D", extra_path = "Species/", name="Transboundary_spp.csv", read = TRUE) %>% 
  clean_names() %>% 
  select(-v1) 

## ----------------- ##
# Global variables
## ----------------- ##

# Year timeframe
year_df <- tibble(year =  c(seq(1951,2005,1), seq(2006,2099,1)),
                  time_period = c(rep("historic", 55), rep("future", 94))
                  )

# List of ensemble members
# ensemble_list <- seq(102,103,1) # for testing
ensemble_list <- seq(102,111,1)

#  List os species
spp_list <- unique(Transboundary_spp$taxon_key)

modeled_spp <- list.files(my_path("R", extra_path = "Proportion_n"))

modeled_spp <- gsub("proportion_","",modeled_spp)
modeled_spp <- gsub(".csv","",modeled_spp)

spp_list <- spp_list[!spp_list %in% modeled_spp]


```

### Proportion routine

```{r Proportion_routine, eval = T, echo = F}

####_______________________ ####
# Estimating proportion change
####_______________________ ####
gc()
t_start <- Sys.time()

mclapply(
  spp_list,
  EstPropChange,
  year = year_df$year,
  data_type = "Catch",
  ensemble_list = ensemble_list,
  path = DBEM_path,
  neighbours = Neighbours
)

t_end <- Sys.time()-t_start;t_end

# Hall 1000 ran it in 5.33 hours past
# Hall 1000 ran it in  hours (July 2020)

```

## Estimating emerging year

This rutine estimates the time (e.g. year) in which the changes in stock share ratio is more likely to happen based on historical variations (e.g. model noise) and future trends (e.g signal). This result uses teh average of the 10 ensemble members

### Fun `GetCentroids` 

This function estimates the distance between the centroid of each neighbouring EEZ and the distribution of the species along both EEZs. We define species centroid as the tile with the highest value of maimum catch potential from all of the species distribution in each year.

```{r GetCentroids, eval = T, echo = F}

GetCentroids <- function(taxon_key,
                         year, 
                         data_type = "Catch",
                         ensemble, 
                         path,
                         Neighbours,
                         eez_centroid,
                         p = 0.95 # percentile of data for central distribution
                         ){
  
  # ----------------- #
  # Get model data from spps for one ensemble
  #  ---------------- #
 if(ensemble == 102){
   print(taxon_key)
 }
    
  Spp_Dist <- read_dbem_ens(
    taxon_key = taxon_key,
    year = year,
    data_type = data_type,
    ensemble = ensemble, # change me to ensemble
    path = my_path("G","DBEM")
  )

  # ----------------- #
  # Extra step 
  # ----------------- #
  
  #### Creates a data to control computational time (lol!)
  #   if(file.exists(paste(my_path("R"),"spp_df.csv",sep="")) == FALSE){
  #   spp_df <- tibble() %>% 
  #     write_csv(.,
  #               paste(my_path("R"),"spp_df.csv",sep=""))
  # }
  # 
  # suppressMessages(
  #   spp_df <- my_path("R",name="spp_df.csv",read = TRUE)
  # )
  # spp_df <- tibble(taxon_key,
  #                  ensemble) %>% 
  #   bind_rows(spp_df) %>% 
  #   write_csv(.,
  #             paste(my_path("R"),"spp_df.csv",sep=""))

  # ----------------- #
  # Estimate distance between centroids
  # ----------------- #
  
  # Filter only the transboundary nature of the species 
  Trans_Spp <- Spp_Dist %>%
    left_join(index_code,
              by= "index") %>% 
    filter(!is.na(value)) %>% 
    semi_join(Transboundary_spp, # filter only transboundary cases
              by = c("taxon_key","eez_name")
    )
  
  # ----------------- #
  # Extra step 
  # ----------------- #
  # Controls for cases with no-data
  nr <- nrow(Trans_Spp)
  if(nr > 0){
    
    # Filter eez by those transboundary
    unique_eez <- unique(Trans_Spp$eez_name)
    
    Neighbours_combo <- Neighbours %>% 
      filter(eez_name %in% unique_eez,
             eez_neighbour %in% unique_eez)
    
    # Get the centroid of each country
    EEZ_centroid <- eez_centroid %>% 
      filter(eez_name %in% Trans_Spp$eez_name) %>% 
      mutate(taxon_key = taxon_key)
    
    # ----------------- #
    # Centroid function
    # ----------------- #
    
    # This function estimates the distance of each neighbouring EEZ
    # It uses Ids wich is a pre-determine identifier of neighbouring
    # EEZs. Fo example Peru and Chile have Id = 167, and viceversa
    
    CentroidsFx <- function(Ids){  
      
      # Filter data by Ids
      EEZ_ids <- Neighbours_combo %>% 
        filter(neighbour_id == Ids)
      
      Sub_Trans_Spp <- Trans_Spp %>% 
        filter(eez_name %in% EEZ_ids$eez_name)
      
      Sub_EEZ_centroid <- EEZ_centroid %>% 
        filter(eez_name %in% EEZ_ids$eez_name)
      
      # Function to get percentiles
      # https://www.tidyverse.org/blog/2020/03/dplyr-1-0-0-summarise/
      quibble <- function(x, q = p) {
        tibble(x = quantile(x, q), q = q)
      }

      # Get the percentile treshold per year, ensemble and neighbour id
      percentile <- Sub_Trans_Spp %>% 
        left_join(EEZ_ids, by = "eez_name") %>% 
        group_by(taxon_key,year,ensemble,neighbour_id) %>%  # for whole distribution
        do(quibble(.$value, p))
      
       Centroids <- Sub_Trans_Spp %>% 
         left_join(EEZ_ids, by = "eez_name") %>% 
         left_join(percentile,
                   by = c("taxon_key","year","ensemble","neighbour_id")
                   ) %>% 
         mutate(to_filter = ifelse(value < x,"out","keep")) %>% 
         filter(to_filter == "keep") %>% 
         group_by(taxon_key,year,ensemble,neighbour_id) %>%  # for whole distribution
         summarise_at(vars(lon,lat),mean) %>% 
         left_join(Sub_EEZ_centroid, by = "taxon_key") %>%
         # select(eez_name =eez_name.y, everything() ,-eez_name.x) %>% 
         # Estimate distances between spp centroid and EEZ centroid
         mutate(
           distance = geodist(longitude, # eez longitude
                              latitude,  # eez latitude
                              lon,  # species longitude
                              lat, # species latitude
                              units="km")
         ) %>% 
         select(taxon_key,eez_name,neighbour_id,ensemble,year,distance)
       
       ### Code to produce graphs for Brazil and ruguay
       
       # name <- paste(taxon_key, "distrbution p = 90%") 
       # Centroids %>% 
       #   # filter(year %in% c(1951,2000,2010)) %>% 
       #   ggplot() +
       #   geom_point(
       #     aes(
       #       x = lon,
       #       y = lat,
       #       size = distance,
       #       color = year,
       #       shape= eez_name
       #     )
       #   ) +
       #   geom_point(
       #     aes(
       #       x = longitude,
       #       y = latitude,
       #     ),
       #     fill = "red"
       #   ) +
       #   geom_sf(data = braur_sf,
       #           aes()
       #   )  +
       #   ggtitle(name)
       # 
       # ggsave(paste(taxon_key,"distribution.jpg",sep="_"),
       # plot = last_plot(),
       # width = 10,
       # height = 8,
       # units = "in",
       # path = my_path("D")
       # )
       
      return(Centroids)
      
    }
    
    # Determine the ids
    Ids <- unique(Neighbours_combo$neighbour_id)
    
    # Run sub-function
    Centroids_Data <- bind_rows(
      lapply(Ids,CentroidsFx)
    )
    
  }else{
    # In case there's no data
    Centroids_Data <- tibble()
    
  }
  
  return(Centroids_Data)
  
}

# Test function

# GetCentroids(taxon_key = 600076,
#              year = year_df$year[1:5],
#              data_type = "Catch",
#              ensemble = 102,
#              Neighbours = Neighbours,
#              eez_centroid = eez_centroid
#              )

# head(Test_centroids)
# unique(Test_centroids$ensemble)
# unique(Test_centroids$neigh)
# 




# braur_sf <- World_ %>% 
#   filter(name %in% c("Brazil","Uruguay"))

# ggplot(braur_sf) +
#   geom_sf() +
  # geom_point(data = subset(Centroids, year %in% seq(1951,2100,20)),
  # geom_point(data = subset(Centroids,eez_name =="Brazil"),
  # geom_point(data = Centroids,
  #            aes(
  #              x = lon,
  #              y = lat,
  #              color = year#,
  #              # size = value
  #            )
  # ) #+
  # facet_wrap(~to_filter+eez_name)


```

### Fun `TransIndex`

This functions takes on `GetCentroids` function and estimates the TransIndex (*TI*) for each pair of neighbouring countries. Presents a 10 years average of the results

$$TI =(\frac{D_{A,y}}{sd(D_{A,h})} - \frac{D_{B,y}}{sd(D_{B,h)}})^2$$

The year of emergece is defined as the first year where the trend is larger than the 95% CI of the historic variation.

Note: If no historic data available then emerging year is the first year of data in an EEZ

```{r TransIndex, eval = T, echo = T}

TransIndex <- function(Centroids, # Expecting the results from the GetCentroids function
                       Id, # A numeric value representing a neighbouring interaction (ONE!)
                       Hist_y = 2005,
                       Plot = F){ # The LAST year of Historical data
  
  
  # Filter data by neighbouring ID
  Centroids_id <- Centroids %>% 
    filter(neighbour_id %in% Id)
  
  EEZ_ids <- Neighbours %>% 
    filter(neighbour_id %in% Id)

  # Historical mean and sd of distance
  historical <- Centroids_id %>%
    filter(year <= Hist_y) %>% 
    ungroup() %>%
    group_by(taxon_key,ensemble,eez_name,neighbour_id) %>%
    summarise_at(vars("distance"),
                 c(hd_temp_mean=mean,
                   hd_temp_sd=sd,
                   n_yrs =~n())
                 )
  
    # Future results
  future <- Centroids_id %>% 
    filter(year > Hist_y)
  
   # Get unique eezs
  Unique_EEZs <- unique(EEZ_ids$eez_name)
  
  # Transboundary Index
  Trans_index <- Centroids_id %>% 
    left_join(historical,
              by = c("taxon_key","eez_name","ensemble","neighbour_id")
    ) %>%
    # Re arrenging table for mutate
    gather("variable","value",distance:hd_temp_sd) %>%
    ungroup() %>% 
    mutate(value = ifelse(is.na(value),0,value)) %>% 
    mutate(
      names = ifelse(eez_name ==Unique_EEZs[1],paste("Country_A",variable,sep="_"),paste("Country_B",variable,sep="_")
    )
    ) %>%
    select(-eez_name,-variable) %>%
    spread(names,value) %>% 
    # mutate index
    mutate(
      trans_index = (Country_A_distance/Country_A_hd_temp_sd - Country_B_distance/Country_B_hd_temp_sd)^2
    # )
    ) %>% 
    # Ten years average of results
    group_by(taxon_key,ensemble,neighbour_id) %>% 
    mutate(RMean = rollmean(x = trans_index, 
                            10, 
                            align = "right", 
                            fill = trans_index,
                            na.rm=T)
    ) %>% 
    # filter(year > 1960) %>%
    select(taxon_key,neighbour_id,year,ensemble,trans_index,RMean)
  
  # Average of 10 years mean of ensemble members results
  mean_sd_index <- Trans_index %>% 
    group_by(taxon_key,year,neighbour_id) %>% 
    summarise_at(vars("RMean"),
                 c(trend=mean,
                   ensemble_sd=sd,
                   n_ens = ~n()
                   
    ),
    na.rm=T
    )
    
    # Valid ensembles
  # Only perform analysis on ensembles containing all years between 1951 and 2040
    n_years <- mean_sd_index %>% 
      group_by(n_ens) %>% 
      summarise(
        n_year = n()
      ) %>% 
      filter(
        n_year == 149
      )
    
    mean_sd_index <- mean_sd_index %>% 
      filter(n_ens %in% n_years$n_ens)
  
  # Estimate noice from ensemble members
  historic_sd <- Trans_index %>% 
    filter(year <= Hist_y) %>% 
    group_by(taxon_key,neighbour_id,ensemble) %>% #Average historic data per year first
    summarise_at(vars("trans_index"),
                 c(trend= mean),
                 na.rm=T
                 ) %>% 
    group_by(taxon_key,neighbour_id) %>% #Capture ensemble variation
    summarise_at(vars("trend"),
                 c(hist_mean=mean,
                   noise=sd,
                   n_ens = ~n())
                 )
  
  
  # For testing
  if(Plot == T & length(historic_sd$hist_mean) > 1){
  # Plot the result, bruh
  
  # Step to determine if data exists
  Plot_Test <- nrow(subset(mean_sd_index, trend > (historic_sd$hist_mean+historic_sd$noise) | trend < (historic_sd$hist_mean-historic_sd$noise)))>0
  
  ggplot() +
    geom_line(data = mean_sd_index,
              aes(
                x = year,
                y = trend
              )
    ) +
    geom_ribbon(data = mean_sd_index,
                aes(x=year,
                    ymin=historic_sd$hist_mean-historic_sd$noise,
                    ymax=historic_sd$hist_mean+historic_sd$noise),
                alpha = 0.5,
                fill = "grey50"
    ) +
    geom_ribbon(data = mean_sd_index,
                aes(x=year,
                    ymin=historic_sd$hist_mean-(historic_sd$noise*2),
                    ymax=historic_sd$hist_mean+(historic_sd$noise)*2)
                ,
                alpha = 0.5,
                fill = "grey30"
    ) +
    geom_line(data = mean_sd_index,
              aes(
                x = year,
                y = historic_sd$hist_mean
              ),
              colour = "grey50"
    ) +
    # Conditional, will only plot circles if the data exists
    {if(Plot_Test)geom_point(data = subset(mean_sd_index, trend > (historic_sd$hist_mean+historic_sd$noise) | trend < (historic_sd$hist_mean-historic_sd$noise)),
               aes(
                 x = year,
                 y = trend,
                 colour = "red",
               ),
               shape = 1,
               size = 3
    )
      } +
    geom_vline(xintercept = Hist_y,colour="blue",alpha = 0.5) +
    scale_x_continuous(breaks = seq(1950,2100,5)) +
    theme_classic()
  
    tk <- unique(mean_sd_index$taxon_key)
  
    ggsave(paste(tk,Id,"plot_example.jpg",sep="_"),
       plot = last_plot(),
       width = 10,
       height = 8,
       units = "in",
       path = my_path("R")
       )
  
  }
  
  # If no historic data then emergin year is the first year of data
  if(nrow(historic_sd) == 0){
    
    Final_Result <- mean_sd_index %>%
      group_by(taxon_key,neighbour_id,n_ens) %>%
      summarise(emerging_yr= min(year)) %>%
      left_join(EEZ_ids,
                by = "neighbour_id") %>%
      ungroup() %>%
      select(taxon_key,eez_name,eez_neighbour,n_ens,emerging_yr) %>% 
      mutate(tresh= NA)
  
  return(Final_Result)
    
  }else{
  
    Final_Result <- mean_sd_index %>%
      filter(year > Hist_y) %>%
      mutate(
        tresh_one = ifelse(trend > (historic_sd$hist_mean+historic_sd$noise) | trend < (historic_sd$hist_mean-historic_sd$noise),"One",NA),
        tresh_two = ifelse(trend > (historic_sd$hist_mean+(2*historic_sd$noise)) | trend < (historic_sd$hist_mean-(2*historic_sd$noise)),"Two",NA)
      ) %>%
      gather("tresh","YesNo",tresh_one,tresh_two) %>% 
      filter(!is.na(YesNo)) %>% 
      group_by(taxon_key,neighbour_id,n_ens,tresh) %>%
      summarise(emerging_yr= min(year)) %>%
      left_join(EEZ_ids,
                by = "neighbour_id") %>%
      ungroup() %>%
      select(taxon_key,eez_name,eez_neighbour,n_ens,emerging_yr,tresh)
  
  return(Final_Result)
  }
}
  



```

### Fun `GetTransIndex`

This is the last function of the emerging year evaluation. It was made so we could run the analysis per each species. The function function simply runs the functions `GetCentroids` by ensabmble member and then `TransIndex` by pairing EEZ. Thus, with this function we run the whole set by species * paired EEZ * ten ensemble members. 

```{r GetTransIndex, eval = T, echo = T}
  
GetTransIndex <- function(taxon_key,
                          year,
                          Hist_y,
                          data_type = "Catch",
                          path,
                          ensemble_list,
                          Neighbours,
                          eez_centroid,
                          Plot = F){
  t_start <- Sys.time()
  print("Starting Step One")
    # First step
    # Call Get centroids fucntion for centroids data per ensemble
  
  Step_one <- bind_rows(
      lapply(ensemble_list,
             GetCentroids,
             taxon_key = taxon_key, # for testing
             year = year_df$year,
             data_type = data_type,
             Neighbours = Neighbours,
             eez_centroid = eez_centroid
             )
    )
  
    
    # Set the different neighbouring pairs
    Ids <- unique(Step_one$neighbour_id)
    
    print("Starting Step Two")
    
    # Second Step
    # Get the transboudary index based on all centroids
    Step_two <- bind_rows(
      lapply(Ids,
             TransIndex,
             Hist_y = Hist_y,
             Centroid = Step_one)
    )
    
    name <- paste(my_path("R",extra_path = "/Emergence_2005/"),taxon_key,"_emergence.txt",sep="")
    
    write_csv(Step_two,
              name)
    
    time_dif <- Sys.time()-t_start
     
    message <- paste("Analysis done for", taxon_key, "in",time_dif, "minutes")
    return(message)
  }
  
  
  # GetTransIndex(
  #   taxon_key = 600076,
  #   ensemble_list = ensemble_list,
  #   year = year_df$year,
  #   Hist_y = 2000,
  #   data_type = "Catch",
  #   Neighbours = Neighbours,
  #   eez_centroid = eez_centroid
  # )


  # spp_list <- c(600004, 600245)
  # 
  #  test <- bind_rows(
  #   lapply(spp_list,
  #          GetTransIndex,
  #          year = year,
  #          data_type = "Catch",
  #          path = path,
  #          Neighbours = Neighbours,
  #          eez_centroid = eez_centroid,
  #          ensemble_list = ensemble_list
  #   )
  # )
  # 
    
```

### Emerging Control Panel

```{r Emerging_control_panel, eval = T, echo = T}

## ----------------- ##
# Data needed for estimating year of emergence
# Note: Use repo = F when running on the Beast or Hall1000
## ----------------- ##

# SAU relations between INDEX and Country's EEZs (see chunk 3)
index_code <- my_path("G", extra_path = "Spatial/SAU/", name="sau_index_code.csv", read = TRUE)

# EEZ list and their centroid of distribution (see chunk 3)
eez_centroid <- my_path("D", extra_path = "Spatial/", name="eez_centroids.csv", read = TRUE)

# Neighbour list and their respective id (see chunk 3)
Neighbours <- my_path("D", extra_path = "Spatial/", name="Neighbours_eez_id.csv", read = TRUE)

# Transboundary species and their sharing EEZs (see Palacios-Abrantes et al; FishForVisa)
Transboundary_spp <- my_path("D", extra_path = "Species/", name="Transboundary_spp.csv", read = TRUE) %>% 
  clean_names()

## ----------------- ##
# Global variables
## ----------------- ##

# Year timeframe
year_df <- tibble(year =  seq(1951,2099,1))

# Last year of "historic" data
Historic_year = 2005

# Data path
# path = DBEM_path

# List of ensemble members
# ensemble_list <- seq(102,103,1) # for testing
ensemble_list <- seq(102,111,1)

#  List os species
spp_list <- unique(Transboundary_spp$taxon_key)

# Already modeled species
spp_done <- list.files(my_path("R", extra_path = "Emergence"))

spp_done <- gsub("\\_.*","",spp_done)

spp_reman <- spp_list[!spp_list %in% spp_done]

rand_plot <- sample(spp_reman,5)


```

### Emerging Routine

```{r Emerging_routine, eval = F, echo = F}

####_______________________ ####
# Estimating year of eergence
####_______________________ ####
n_cores <- 24
t_start <- Sys.time()

gc()

    Emerging_result <- bind_rows(
      mclapply(spp_list,
               GetTransIndex,
               year = year_df$year,
               Hist_y = Historic_year,
               data_type = "Abd",
               ensemble_list = ensemble_list,
               Neighbours = Neighbours,
               eez_centroid = eez_centroid,
               Plot = F
      )
    )

```


```{r Emerging_routine_DoPar, eval = F, echo = F}

library(doParallel)
library(doSNOW)

cl <- makeCluster(12)
registerDoSNOW(cl)


# To show processing times
repetitions <- length(spp_reman)
pb <- txtProgressBar(max = repetitions, style = 3)

progress <- function(n) setTxtProgressBar(pb, n)
opts <- list(progress = progress)


foreach(i=1:repetitions,
        .combine = rbind,
        .packages = c("MyFunctions",packages),
        .options.snow = opts,
        .verbose = T) %dopar% 
  GetTransIndex(
    taxon_key =spp_reman[i],
    ensemble_list = ensemble_list,
    year = year_df$year,
    Hist_y = 2000,
    data_type = "Catch",
    Neighbours = Neighbours,
    eez_centroid = eez_centroid
  )

close(pb)
stopCluster(cl)

```


## SST time of emergence


##### Fun `GetEnvData`

```{r get_env_data, eval = T, echo = T}


getEnvVar=function(yr,ensemble,Variable){
  
  filepath <- paste("Z:/DATA/Environmental data/GFDL_CMIP5_Large_Ensemble/ens",ensemble,"",sep="/")
  
  if(Variable == "sst"){
    sst = paste("SST_",yr,".txt",sep="")
    read_me_sst <- paste(filepath,sst,sep="")[1]
    data <- read.csv(read_me_sst,header=F)  
    
  }
  
  
  if(Variable == "botom"){
    botom = paste("botom_",yr,".txt",sep="")
    read_me_botom <- paste(filepath,botom,sep="")[1]
    data <- read.csv(read_me_botom,header=F)
  }
  
  # Retrun
  
  getTemp <- data %>% 
    mutate(ensemble = ensemble)
}



```

```{r temp_emergence, eval = F, echo = F}


TempEmer <- function(Hist_y = 2005){ # The LAST year of Historical data
  
  
  # Historical mean and sd of distance
  historical <- Centroids_id %>%
    filter(year <= Hist_y) %>% 
    ungroup() %>%
    group_by(taxon_key,ensemble,eez_name,neighbour_id) %>%
    summarise_at(vars("distance"),
                 c(hd_temp_mean=mean,
                   hd_temp_sd=sd,
                   n_yrs =~n())
                 )
  
    # Future results
  future <- Centroids_id %>% 
    filter(year > Hist_y)
  
   # Get unique eezs
  Unique_EEZs <- unique(EEZ_ids$eez_name)
  
  # Transboundary Index
  Trans_index <- Centroids_id %>% 
    left_join(historical,
              by = c("taxon_key","eez_name","ensemble","neighbour_id")
    ) %>%
    # Re arrenging table for mutate
    gather("variable","value",distance:hd_temp_sd) %>%
    ungroup() %>% 
    mutate(value = ifelse(is.na(value),0,value)) %>% 
    mutate(
      names = ifelse(eez_name ==Unique_EEZs[1],paste("Country_A",variable,sep="_"),paste("Country_B",variable,sep="_")
    )
    ) %>%
    select(-eez_name,-variable) %>%
    spread(names,value) %>% 
    # mutate index
    mutate(
      trans_index = (Country_A_distance/Country_A_hd_temp_sd - Country_B_distance/Country_B_hd_temp_sd)^2
    # )
    ) %>% 
    # Ten years average of results
    group_by(taxon_key,ensemble,neighbour_id) %>% 
    mutate(RMean = rollmean(x = trans_index, 
                            10, 
                            align = "right", 
                            fill = trans_index,
                            na.rm=T)
    ) %>% 
    # filter(year > 1960) %>%
    select(taxon_key,neighbour_id,year,ensemble,trans_index,RMean)
  
  # Average of 10 years mean of ensemble members results
  mean_sd_index <- Trans_index %>% 
    group_by(taxon_key,year,neighbour_id) %>% 
    summarise_at(vars("RMean"),
                 c(trend=mean,
                   ensemble_sd=sd,
                   n_ens = ~n()
                   
    ),
    na.rm=T
    )
    
    # Valid ensembles
  # Only perform analysis on ensembles containing all years between 1951 and 2040
    n_years <- mean_sd_index %>% 
      group_by(n_ens) %>% 
      summarise(
        n_year = n()
      ) %>% 
      filter(
        n_year == 149
      )
    
    mean_sd_index <- mean_sd_index %>% 
      filter(n_ens %in% n_years$n_ens)
  
  # Estimate noice from ensemble members
  historic_sd <- Trans_index %>% 
    filter(year <= Hist_y) %>% 
    group_by(taxon_key,neighbour_id,ensemble) %>% #Average historic data per year first
    summarise_at(vars("trans_index"),
                 c(trend= mean),
                 na.rm=T
                 ) %>% 
    group_by(taxon_key,neighbour_id) %>% #Capture ensemble variation
    summarise_at(vars("trend"),
                 c(hist_mean=mean,
                   noise=sd,
                   n_ens = ~n())
                 )
  
  
  # For testing
  if(Plot == T & length(historic_sd$hist_mean) > 1){
  # Plot the result, bruh
  
  # Step to determine if data exists
  Plot_Test <- nrow(subset(mean_sd_index, trend > (historic_sd$hist_mean+historic_sd$noise) | trend < (historic_sd$hist_mean-historic_sd$noise)))>0
  
  ggplot() +
    geom_line(data = mean_sd_index,
              aes(
                x = year,
                y = trend
              )
    ) +
    geom_ribbon(data = mean_sd_index,
                aes(x=year,
                    ymin=historic_sd$hist_mean-historic_sd$noise,
                    ymax=historic_sd$hist_mean+historic_sd$noise),
                alpha = 0.5,
                fill = "grey50"
    ) +
    geom_ribbon(data = mean_sd_index,
                aes(x=year,
                    ymin=historic_sd$hist_mean-(historic_sd$noise*2),
                    ymax=historic_sd$hist_mean+(historic_sd$noise)*2)
                ,
                alpha = 0.5,
                fill = "grey30"
    ) +
    geom_line(data = mean_sd_index,
              aes(
                x = year,
                y = historic_sd$hist_mean
              ),
              colour = "grey50"
    ) +
    # Conditional, will only plot circles if the data exists
    {if(Plot_Test)geom_point(data = subset(mean_sd_index, trend > (historic_sd$hist_mean+historic_sd$noise) | trend < (historic_sd$hist_mean-historic_sd$noise)),
               aes(
                 x = year,
                 y = trend,
                 colour = "red",
               ),
               shape = 1,
               size = 3
    )
      } +
    geom_vline(xintercept = Hist_y,colour="blue",alpha = 0.5) +
    scale_x_continuous(breaks = seq(1950,2100,5)) +
    theme_classic()
  
    tk <- unique(mean_sd_index$taxon_key)
  
    ggsave(paste(tk,Id,"plot_example.jpg",sep="_"),
       plot = last_plot(),
       width = 10,
       height = 8,
       units = "in",
       path = my_path("R")
       )
  
  }
  
  # If no historic data then emergin year is the first year of data
  if(nrow(historic_sd) == 0){
    
    Final_Result <- mean_sd_index %>%
      group_by(taxon_key,neighbour_id,n_ens) %>%
      summarise(emerging_yr= min(year)) %>%
      left_join(EEZ_ids,
                by = "neighbour_id") %>%
      ungroup() %>%
      select(taxon_key,eez_name,eez_neighbour,n_ens,emerging_yr) %>% 
      mutate(tresh= NA)
  
  return(Final_Result)
    
  }else{
  
    Final_Result <- mean_sd_index %>%
      filter(year > Hist_y) %>%
      mutate(
        tresh_one = ifelse(trend > (historic_sd$hist_mean+historic_sd$noise) | trend < (historic_sd$hist_mean-historic_sd$noise),"One",NA),
        tresh_two = ifelse(trend > (historic_sd$hist_mean+(2*historic_sd$noise)) | trend < (historic_sd$hist_mean-(2*historic_sd$noise)),"Two",NA)
      ) %>%
      gather("tresh","YesNo",tresh_one,tresh_two) %>% 
      filter(!is.na(YesNo)) %>% 
      group_by(taxon_key,neighbour_id,n_ens,tresh) %>%
      summarise(emerging_yr= min(year)) %>%
      left_join(EEZ_ids,
                by = "neighbour_id") %>%
      ungroup() %>%
      select(taxon_key,eez_name,eez_neighbour,n_ens,emerging_yr,tresh)
  
  return(Final_Result)
  }
}
  



```


```{r william_code, eval = F, echo = F}

datascale<-subset(testdata,!is.na(MHW) & !is.na(MeanChange))
MHWBreaks<-c(0.2,0.4,0.5,0.6,0.8,2.1)
MeanChangeBreaks<-c(-0.4,0.6,0.7,0.8,1.0,2.0)
#testdata$MHW <- with(testdata, cut(MHW,
#                                   breaks=quantile(MHW, probs=seq(0,1, by=0.2), na.rm=TRUE),
#                                   include.lowest=TRUE))
testdata$MHW <- with(testdata, cut(MHW,
                                   breaks=MHWBreaks, na.rm=TRUE),
                                   include.lowest=TRUE)
testdata$MHW <- as.numeric(testdata$MHW)
#testdata$MeanChange <- with(testdata, cut(MeanChange,
#                                          breaks=quantile(MeanChange, probs=seq(0,1, by=0.2), na.rm=TRUE),
#                                          include.lowest=TRUE))
testdata$MeanChange <- with(testdata, cut(MeanChange,
                                          breaks=MeanChangeBreaks, na.rm=TRUE),
                                          include.lowest=TRUE)

testdata$MeanChange <- as.numeric(testdata$MeanChange)  

library(ggplot2)
d <- data.frame(testdata,fill_val = rgb(blue=0.5,red = testdata$MHW/5, green = testdata$MeanChange/5))

world <- map_data("world")
map<- ggplot(d, aes(x=lon, y=lat)) +
  geom_tile(aes(fill = fill_val)) +
  scale_fill_identity()+
  geom_cartogram(data=world, map=world,
                 aes(x=long, y=lat, map_id=region),fill="white",color="black")+
  coord_quickmap(xlim=c(-180,180), ylim=c(-89, 90))+
  ylab("")+
  xlab("")+
  scale_y_continuous(expand = c(0, -5))+
  scale_x_continuous(expand = c(0, 0))+
  labs(title=paste("(A) Sea Surface Temperature",sep=""))+
  theme(axis.line = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position="bottom",
        #panel.border = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=1),
        panel.background = element_blank(),
        #axis.text.y=element_blank(),
        axis.text=element_text(size=9,colour="black"),
        plot.title=element_text(hjust=0,vjust=-0.4,face="bold",size=24)
  )
dlegend <- expand.grid(x = seq(0, 1, 0.25), y = seq(0, 1, 0.25)) %>%
  mutate(mix2 = rgb(red = x, green = y, blue = 0.5))
library(cowplot)
xyLegend <- ggplot(dlegend, aes(x, y)) +
  geom_tile(aes(fill = mix2)) +
  scale_fill_identity() +
  labs(x = "Higher MHW change->",
       y = "Higher mean change->") +
  theme_void() +
  theme(axis.title = element_text(size = 8),
        axis.title.y = element_text(angle = 90)) +
  coord_fixed()
p=ggdraw() +
  draw_plot(map, 0, 0, 1, 1) +
  draw_plot(xyLegend, 0.05, 0.1, 0.2, 0.2)
#ggsave(p,filename="/Users/william/Google Drive/Projects/MHWs Global/MHW_SST_plot.png",height=9,width=8,dpi=300)
ggsave(map,filename="/Users/william/Google Drive/Projects/MHWs Global/MHW_SST_plot_map.png",height=8,width=11,dpi=300) (edited) 


```

# Results

## Percentage Change

This results only shows the average percentage change in proportion of all speecies within an EEZ without relationship with neighbours

### Functions and Data needed

#### Fun `SummaryProp`

This function estimates the total change in MCP proportion of each species for each EEZ. It looses the connection with neighbours as you only know for x species houw much is the proportion changing.

```{r fun_SummaryProp, eval = F, echo =F}

SummaryProp <- function(taxon_key,links="NA"){
  
  # Reads taxon data
  proportion_data <- fread(paste(my_path("R",extra_path = "Proportion_2005/"),"proportion_",taxon_key,".csv", sep=""))
  
  if(links == "y"){
    # summarizes by country and neighbour
    country_summary <- proportion_data %>% 
      group_by(taxon_key,eez_name,eez_neighbour,time_step) %>% 
      summarise(
        mean_spp = mean(ensemble_mean, na.rm = T) # average spp change from all countries sharing
      ) %>% 
      filter(!is.na(mean_spp))
    
  }else{
    # summarizes by country
    country_summary <- proportion_data %>% 
      group_by(taxon_key,eez_name,time_step) %>% 
      summarise(
        mean_spp = mean(ensemble_mean,na.rm=T) # average spp change from all countries sharing
      ) %>% 
      filter(!is.na(mean_spp))
    }
  
  return(country_summary)
}

```


#### Fun `EEZProp`

The next step is to summarize all species per eez so our results shows average change of all species within an EEZ towards a neighbour

```{r fun_EEZProp, eval = F, echo = F}

EEZProp <- function(taxon_list,links="NA"){

 spp <- bind_rows(
   lapply(taxon_list,SummaryProp,links)
   )
 
 if(links == "y"){
   
   eez_summary <- spp %>% 
     group_by(eez_name,eez_neighbour,time_step) %>% 
     summarise(
       n_spp = n(),
       min_eez = min(mean_spp, na.rm=T),
       max_eez = max(mean_spp, na.rm=T),
       sd_eez = sd(mean_spp, na.rm=T), # for some weird reason it wont work if the order is fliped
       mean_eez = mean(mean_spp,na.rm=T)
     ) %>% 
     select(eez_name:max_eez,mean_eez,sd_eez)
   
 }else{
 
   eez_summary <- spp %>% 
   group_by(eez_name,time_step) %>% 
   summarise(
       n_spp = n(),
       min_eez = min(mean_spp, na.rm=T),
       max_eez = max(mean_spp, na.rm=T),
       sd_eez = sd(mean_spp, na.rm=T), # for some weird reason it wont work if the order is fliped
       mean_eez = mean(mean_spp,na.rm=T)
     ) %>% 
     select(eez_name:max_eez,mean_eez,sd_eez)
 
 
 }
 
 return(eez_summary)

}

```

#### Fun `PropChange`

Finally, we estimate the average proportion change of all species within each eez

```{r fun_PropChange, eval = F, echo =F}

PropChange <- function(taxon_list,links="NA"){

 eez <- EEZProp(taxon_list,links)
 
 proportion_change <- eez %>% 
   gather("variable","value",n_spp:sd_eez) %>% 
   spread(time_step,value) %>% 
   mutate_at(vars(
     "per_early" = early,
     "per_mid" = mid
     ),
            funs(round((((.-historical)/historical))*100,2))
   )
 
 return(proportion_change)

}

```

### Run Results Analysis

#### Read Data for Analysis

```{r General_Data, eval = F, echo =F}

# --------------- #
# General Data needed
# --------------- #

# Get taxon list
Taxon_list_emer <- list.files(my_path("R",extra_path = "Emergence_2005"))

# clean names for function
Taxon_list_emer <- gsub("_.*","",Taxon_list_emer) 

# SAU exploited species list
Exploited_spp_list <- my_path("G","SAU","exploited_species_list.csv",read = T) %>%
  clean_names() %>% 
  pull(taxon_name)

# Get habitat preference from fishbase
Spp_env_pref <- rbind(species(Exploited_spp_list, #species from rfishbase package
                              fields = species_fields$habitat[4])
                      ) %>% 
  mutate(taxon_name = Exploited_spp_list) %>% 
  left_join(my_path("G","SAU","exploited_species_list.csv", read = T) %>%
              clean_names(),
            by = "taxon_name")

# Neighbour list and their respective id (see chunk 3)
Neighbours <- my_path("D", extra_path = "Spatial/", name="Neighbours_eez_id.csv", read = TRUE)

# Clean names to match data
Matching_names <- my_path("G","Spatial/SAU", "matching_names.csv", read = T) %>% 
  rename(eezid = eez_id)

Fishing_names <- Matching_names %>% 
  group_by(sau_fishing_entity,fishing_entity_id) %>% 
  summarise(n=n()) %>% 
  select(-n)

# eez_centroids
Eez_centroids <- my_path("D", extra_path = "Spatial/", name="eez_centroids.csv", read = TRUE) %>% 
  rename(sf_eez_name = eez_name) %>% 
  left_join(Matching_names) %>% 
  select(eezid,latitude,longitude)

# Species depth clasification (SAU-fishbase)
Spp_depth <-fread(paste(my_path("D"),"SAU/SppTaxonName.csv", sep ="")) %>% 
  clean_names()

# Temperature Time of Emergence
Toe_temp <- left_join(my_path("D","Climate", "ToE_sst.csv", read = T),
                      my_path("D","Climate", "ToE_bottemp.csv", read = T)
                      ) %>% 
  clean_names()

# Biogeographic regions (from Rey 2020)
Biogeo_reg <-fread(paste(my_path("D"),"Climate/SPATIAL_PARTITION_OCEAN.csv", sep ="")) %>% 
  clean_names() %>% 
  rowid_to_column("index")

# Get eez to index relational data
EEZ_CellID <- my_path("G", extra_path = "Spatial/DBEM", name="EEZ_CellID.xlsx", read = TRUE) %>%
  clean_names()
colnames(EEZ_CellID) <- c("eezid","index")

Eez_biogeo <- EEZ_CellID %>% 
  # filter(eezid == 191) %>% 
  left_join(Biogeo_reg,
       by = "index") %>% 
  # Deal with NaNs in data
  mutate(biome = ifelse(biome == "NaN",0,biome)) %>% 
  filter(biome > 0) %>% 
  # Get frequency of biome per index
  group_by(eezid,biome) %>% 
  summarise(nbiom=n()) %>% 
  # Select the more frequent biome per eez
  group_by(eezid) %>% 
  top_n(1,nbiom) %>% 
  ungroup() %>% 
  select(-nbiom) %>% 
  distinct(eezid, .keep_all = T) # Croatia is 1/2. We arbritary allocated the first one

# Species catch trend (from FishForVisa)

Catch_trend <- my_path("D","Species","Catch_trend.csv", read = T) %>% 
  clean_names() %>% 
  filter(taxon_key %in% Taxon_list_emer) %>% 
  rename(sau_fishing_entity = territory) %>% 
  left_join(Fishing_names,
            by = "sau_fishing_entity") %>% 
  filter(status != "No Trend") %>% 
  mutate(category = ifelse(status %in% c("Developing","Rebuilding"),"Category A",
                         ifelse(status == "Max Exploited","Category B",
                                ifelse(status %in% c("Over Exploited","Collapsed","Category C"),"Category C", "No Category")
                         )
         )
  )


# --------------- #
# Load Proportion results
# --------------- #


# Read proportion results
# prop_results <- PropChange(Taxon_List_emer, links="y") %>% 
  # filter(!is.na(eez_neighbour)) %>% 
  # mutate(per_mid_plot =ifelse(per_mid >= 50, 50,
  #                          ifelse(per_mid <= -50,-50,per_mid)
  #                          ),
  #        per_early_plot =ifelse(per_early >= 50, 50,
  #                          ifelse(per_early <= -50,-50,per_early)
  #                          )
  #        )

# For dat availabillity
 # write_csv(prop_results,
          # "proportion_change_2005.csv")


Prop_results <- my_path("R",name="proportion_change_2005.csv", read=T)

# --------------- #
# Load year of emergence results
# --------------- #

Paths <- paste(my_path("R",extra_path = "Emergence_2005"),Taxon_list_emer,"_emergence.txt",sep="")

# Load all sp in one table
Eme_Res <- bind_rows(lapply(Paths, fread)) %>% 
  filter(
    n_ens == 10
  ) %>% 
  left_join(Neighbours,
            by = c("eez_name","eez_neighbour")
  ) %>% 
  rename(sf_eez_name=eez_name) %>% 
  left_join(Matching_names,
            by=  "sf_eez_name") %>% 
  clean_names()

# warnings() for empty data species

# View(Eme_Res)

# --------------- #
# Load SAU catch and revenue data
# --------------- #

Sau_data <-fread(paste(my_path("D"),"SAU/sau_catch_value_country_taxon_JEPA.csv", sep ="")) %>%
  clean_names() %>% 
  # Remove high seas and 207 and 208 that are unknown
  filter(!fishing_entity_id %in% c(213,223)) %>%  # 207,208
  # Allocate catch of islands to UK
  mutate(fishing_entity_id = ifelse(fishing_entity_id %in% c(219,220), 183,fishing_entity_id)) %>% 
  # Convert to 2019 real USD
  mutate(values = 1.16 * value) %>%
  # Average 10 years of data
  group_by(fishing_entity_id,taxon_key) %>% 
  summarise_at(c("catch","value"),
               mean,na.rm=T) %>% 
  gather("variable","value",catch:value)


# --------------- #
# Load shapefiles for figures
# --------------- #

# Load SAU shapefile name and paths

# The path
path_world <- my_path("G", extra_path = "Spatial/SAU/SAU_Shapefile")

# The File
fnam_world <- "SAUEEZ_July2015.shp"

# Load it!
World_eez_sf <- st_read(dsn = path_world,
                        layer =file_path_sans_ext(fnam_world)) %>% 
  rename(eez_name = Name) %>% 
  st_transform(crs = 4326) %>% # 4326
  # st_transform(crs = "+proj=eck4") %>% # for tbular plot
  st_simplify(preserveTopology = TRUE, dTolerance = 0.1) %>% 
  clean_names()

# Call world map from natural earth

World_map_dat <- Matching_names %>% 
  group_by(sau_fishing_entity,fishing_entity_id,iso_a3) %>% 
  summarise(n=n()) %>% 
  select(-n) 

World_map <- rnaturalearth::ne_countries(scale = 'small', returnclass = c("sf")) %>%
  clean_names() %>% 
  # st_transform(crs = "+proj=eck4") %>%
  st_transform(crs = 4326) %>% # 4326
  left_join(World_map_dat,
            by = "iso_a3")
  

# Load eez_centroid data
Eez_centroid <- my_path("D", "Spatial","eez_centroids.csv",read = T)

# Tranform to tubular
Eez_centroid_sf <-st_as_sf(Eez_centroid,
            coords = c("longitude", "latitude")
            ) %>% 
  st_set_crs(4326) #%>% # to match shapefiles
  # st_transform(crs = "+proj=eck4")

# Transform sf to df
Eez_centroid_eck <- as.data.frame(Eez_centroid_sf)

Eez_centroid_eck <- do.call(rbind, st_geometry(Eez_centroid_sf)) %>% 
  as_tibble() %>% 
  setNames(c("lon","lat")) %>% 
  bind_cols(Eez_centroid) %>% 
  select(eez_name,longitude = lon,latitude = lat)

```

####  Prooportion Analysis

##### Fig. Percentage Change Map

```{r fig_map_per, eval = F, echo =F}

World_sf %>% 
  left_join(results,
            by = "eez_name") %>% 
  filter(variable %in% c("mean_spp")#,
         # eez_name %in% c("Peru","Chile","Ecuador","Argentina")
         ) %>% 
  ggplot() +
  geom_sf(
    aes(
      fill = per_mid
    )
  ) + 
  geom_sf(data=country10_sf) +
  scale_fill_gradient2("Average Change in\nStock-Share Ratio (%)\nBy Mid Century") +
  ggtheme_map() +
  ggsave("per_mid.png",
         width = 10,
         height = 6,
         units = "in"
  )

```

##### Fig. 1 and S1. (Netowrk)

```{r fig_map_Juan, eval = F, echo =F}
# Figure made thanks to Juanito!
# http://jsmayorga.com/post/mapping-the-global-network-of-transnational-fisheries/

# Prepare data from results
Data <- Prop_results %>% 
  # get coords for sources
  left_join(Eez_centroid,
            by = "eez_name") %>%
  rename(source = eez_name,
         start_lon = longitude,
         start_lat = latitude,
         eez_name=eez_neighbour) %>% 
  # get coords for targets
  left_join(Eez_centroid,
            by = "eez_name") %>% 
  rename(target = eez_name,
         end_lon = longitude,
         end_lat = latitude) %>% 
  ungroup() %>% 
  # Plot miscs
  mutate(
    per_early = ifelse(is.na(per_early),0,per_early),
    per_mid = ifelse(is.na(per_mid),0,per_mid)
  ) %>% 
  drop_na() %>%
  filter(
    variable %in% c("mean_eez","n_spp")#,
    # source %in% c("Brazil","Argentina","Chile","Peru","Uruguay")
  )

# Convert to data to spatial
network_data_sf <- Data %>%
  select(start_lon, start_lat, end_lon, end_lat) %>% 
  purrr::transpose() %>% 
  purrr::map(~ matrix(flatten_dbl(.), nrow = 2, byrow = TRUE)) %>% 
  purrr::map(st_linestring) %>%
  st_sfc(crs = 4326) %>%
  # st_sfc(crs = "+proj=eck4") %>% # for tbular plot
  st_sf(geometry = .)%>%
  bind_cols(Data) %>%
  select(everything(), geometry) %>% 
  # Set circles ('cus the world is not flat!)
  st_segmentize(units::set_units(100, km)) %>% 
  mutate(geometry = (geometry + c(180,90)) %% c(360) - c(180,90)) %>%
  st_wrap_dateline(options = c("WRAPDATELINE=YES",  "DATELINEOFFSET=180"), quiet = TRUE) %>%
  sf::st_sf(crs = 4326)
  # sf::st_sf(crs = "+proj=eck4") # for tbular plot


#  unpack the coordinates of each feature 
coord_data <- as.data.frame( st_coordinates(st_cast(network_data_sf,"MULTILINESTRING")$geometry))

c(network_data_sf$line_id, network_data_sf$coords) %<-% (
  coord_data %>% 
    rename(subline_id = L1) %>%   
    nest(-L2)
)

# Create data path for line connections
paths <- network_data_sf %>% 
  sf::st_set_geometry(NULL) %>% 
  unnest() %>% 
  mutate_at(vars(X,Y), round,2) %>% 
  gather("time_step","per_chng",per_early:per_mid) %>% 
  mutate(per_plot = ifelse(per_chng > 100,100,per_chng))
  
# Plot it!

# Proportion map data 
Map_data <- Data %>% 
  gather("time_step","per_chng",per_early:per_mid) %>% 
  mutate(per_plot = ifelse(per_chng > 100,100,per_chng))

# Average number of taxa to change per eez

n_taxa_data <- Prop_results %>% 
  filter(variable == "n_spp") %>% 
  rename(sf_eez_name = eez_name) %>% 
  left_join(Matching_names) %>% 
  group_by(sau_fishing_entity,fishing_entity_id) %>% 
  summarise(total_spp = mean(early,na.rm=T))
  
n_taxa_map <- World_map %>% 
  left_join(n_taxa_data,
            by = c("sau_fishing_entity","fishing_entity_id")
            )



gc()# clean ram

# time <- "per_mid_plot"
time <- "per_early"

## ------------------- ##
# Global Plot
## ------------------- ##


Prop_map <- ggplot() +
  geom_sf(data = subset(n_taxa_map, sovereignt != "Antarctica"),
          aes(fill = total_spp),
          size = 0.1,col = "white") +
geom_sf(data = World_eez_sf, size = 0.1, fill = "white", col = "gray30") +
geom_point(data = subset(Map_data, time_step == time & per_plot < 0),
           aes(start_lon,
               start_lat,
               col = per_plot),
           size = 0.05,
           col = "gray80",
           shape = 20,
           stroke = 1.5) +
geom_path(data = subset(paths, time_step == time & per_plot > 0),
          aes(X,
              Y,
              group = interaction(line_id,subline_id),
              col = per_plot
          ),
          size = 0.3,
          lineend = "round",
          arrow = arrow(length = unit(0.008, "npc"),
                        ends = "first"),
          show.legend = NA) +
  my_ggtheme_m() +
scale_colour_viridis(
  name="Average Gain of Stock-Share Ratio (%)\nand Number of taxa (n)",
  limits = c(0,max(Map_data$per_plot)),
  breaks = seq(0,max(Map_data$per_plot),10)#,
  # option="magma",
  # direction = -1
) +
scale_fill_viridis(
  name="Average Gain of Stock-Share Ratio (%)\nand Number of taxa (n)",
  limits = c(0,max(Map_data$per_plot)),
  breaks = seq(0,max(Map_data$per_plot),10)#,
  # alpha = 0.8
  # option="magma",
  # direction = -1
) +
ggsave("./Figures/fig2ax.png",
       width = 12,
       height = 8,
       units = "in"
)


## ------------------- ##
# Regional Plots
## ------------------- ##

Lat_am_land <- World_map %>% 
  filter(region_wb %in% c("Latin America & Caribbean") |
          sau_fishing_entity %in% c("USA","Mexico")
         )

Lat_am_eez <- World_eez_sf %>% 
  rename(sf_eez_name = eez_name) %>% 
  left_join(Matching_names) %>% 
  filter(
    # sau_fishing_entity %in% Lat_am_land$sau_fishing_entity,
         !str_detect(sf_eez_name,"Pacific"),
         !sf_eez_name %in% c("USA (East Coast)","Suriname","Guyana","French Guiana","Bermuda (UK)","Brazil","El Salvador")
         )

# Lat_am_eez %>% filter(str_detect(sf_eez_name,"Tri")) 

Lat_am_data <- Map_data %>% 
  filter(source %in% Lat_am_eez$sf_eez_name)

Lat_am_paths <- paths %>% 
  filter(source %in% Lat_am_eez$sf_eez_name,
         target %in% Lat_am_eez$sf_eez_name)


Lat_am_map <- ggplot() +
  geom_sf(data = Lat_am_eez, size = 0.1, fill = "white", col = "gray30") +
  geom_sf(data = subset(n_taxa_map, sovereignt != "Antarctica"),
          aes(fill = total_spp),
          size = 0.1,col = "white") +
  geom_point(data = subset(Lat_am_data, time_step == time & per_plot < 0 ),
             aes(start_lon,
                 start_lat,
                 col = per_plot),
             size = 1,
             col = "gray30",
             shape = 20,
             stroke = 1.5) +
  geom_path(data = subset(Lat_am_paths, time_step == time & per_plot > 0),
            aes(X, Y,
                group = interaction(line_id,subline_id),
                col = per_plot
            ),
            size = 1,
            arrow = arrow(length = unit(0.05, "npc"),
                          ends = "first"),
            show.legend = NA) +
  coord_sf(xlim = c(-100, -55),ylim = c(9, 30)) + 
  labs(x = "Lon", y = "Lat") +
  scale_x_continuous(breaks = seq(-100,60,10)) +
  scale_y_continuous(breaks = seq(10,30,5)) +
  # my_ggtheme_m() +
  theme(legend.position = "",
        panel.background = element_rect(fill = "white", color = "white"),
        panel.grid.major =  element_line(color = "white")
        ) +
  scale_colour_viridis(
    name="Average Gain of\nStock-Share Ratio (%)",
    limits = c(0,max(Lat_am_data$per_plot)),
    breaks = seq(0,max(Lat_am_data$per_plot),10),
    # option="magma",
    # direction = -1
  )+
  scale_fill_viridis(
    name="Average Gain of\nStock-Share Ratio (%)",
    limits = c(0,max(Lat_am_data$per_plot)),
    breaks = seq(0,max(Lat_am_data$per_plot),10),
    # option="magma",
    # direction = -1
  );Lat_am_map


## ------------------- ##
# The Med
## ------------------- ##

# Land polygon
Med_land <- World_map %>% 
  filter(region_wb %in% c("Europe & Central Asia","Middle East & North Africa") |
          sau_fishing_entity %in% c("Spain","France")
         )

# EEZ polygon
Med_eez <- World_eez_sf %>% 
  rename(sf_eez_name = eez_name) %>% 
  left_join(Matching_names) %>% 
  filter(sau_fishing_entity %in% Med_land$sau_fishing_entity,
         sf_eez_name != "Spain (Northwest)")

# Med data
Med_data <- Map_data %>% 
  filter(source %in% Med_eez$sf_eez_name)

# Med paths
Med_paths <- paths %>% 
  filter(source %in% Med_eez$sf_eez_name,
         target %in% Med_eez$sf_eez_name)

# Med plot
Med_map <- ggplot() +
  geom_sf(data = Med_eez, size = 0.5, fill = "white", col = "gray30") +
  geom_sf(data = subset(n_taxa_map, sovereignt != "Antarctica"),
          aes(fill = total_spp),
          size = 0.1,col = "white") +
  geom_point(data = subset(Med_data, time_step == time & per_plot < 0 ),
             aes(start_lon,
                 start_lat,
                 col = per_plot),
             size = 1,
             col = "gray30",
             shape = 20,
             stroke = 1.5) +
  geom_path(data = subset(Med_paths, time_step == time & per_plot > 0),
            aes(X, Y,
                group = interaction(line_id,subline_id),
                col = per_plot
            ),
            size = 1,
            arrow = arrow(length = unit(0.05, "npc"),
                          ends = "first"),
            show.legend = NA) +
  coord_sf(xlim = c(-3, 35),ylim = c(30, 45)) +
  labs(x = "Lon", y = "Lat") +
  scale_x_continuous(breaks = seq(-5,35,10)) +
  scale_y_continuous(breaks = seq(30,50,5)) +
  # my_ggtheme_m() +
  theme(legend.position = "",
        panel.background = element_rect(fill = "white", color = "white"),
        panel.grid.major =  element_line(color = "white")
        ) +
  scale_colour_viridis(
    name="Average Gain of\nStock-Share Ratio (%)",
    limits = c(0,max(Med_data$per_plot)),
    breaks = seq(0,max(Med_data$per_plot),5),
    # option="magma",
    # direction = -1
  )+
  scale_fill_viridis(
    name="Average Gain of\nStock-Share Ratio (%)",
    limits = c(0,max(Med_data$per_plot)),
    breaks = seq(0,max(Med_data$per_plot),5),
    # option="magma",
    # direction = -1
  );Med_map

## ------------------- ##
# Northern Europe
## ------------------- ##

Eu_land <- World_map %>% 
  filter(
    continent == "Europe",
    sau_fishing_entity != "Iceland"
    )

# 
# ggplot(N_Eu_land) +
#   geom_sf() 
  

Eu_eez <- World_eez_sf %>% 
  rename(sf_eez_name = eez_name) %>% 
  left_join(Matching_names) %>% 
  filter(
    !sf_eez_name %in% c("Iceland", "Norway","Italy","Greece","Croatia","Bulgaria","Romania"),
    !str_detect(sf_eez_name,"Spain")
  )

# Eu_eez %>% filter(str_detect(sf_eez_name,"Romania"))

Eu_data <- Map_data %>% 
  filter(source %in% Eu_eez$sf_eez_name)

Eu_paths <- paths %>% 
  filter(source %in% Eu_eez$sf_eez_name,
         target %in% Eu_eez$sf_eez_name)


Eu_map <- ggplot() +
  geom_sf(data = Eu_eez, size = 0.5, fill = "white", col = "gray30") +
  geom_sf(data = subset(n_taxa_map, sovereignt != "Antarctica"),
          aes(fill = total_spp),
          size = 0.1,col = "white") +
  geom_point(data = subset(Med_data, time_step == time & per_plot < 0 ),
             aes(start_lon,
                 start_lat,
                 col = per_plot),
             size = 1,
             col = "gray30",
             shape = 20,
             stroke = 1.5) +
  geom_path(data = subset(Eu_paths, time_step == time & per_plot > 0),
            aes(X, Y,
                group = interaction(line_id,subline_id),
                col = per_plot
            ),
            size = 1,
            arrow = arrow(length = unit(0.05, "npc"),
                          ends = "first"),
            show.legend = NA) +
  coord_sf(xlim = c(-15, 30), ylim = c(45, 65)) +
  labs(x = "Lon", y = "Lat") +
  scale_y_continuous(breaks = seq(45,65,10)) +
  # scale_x_continuous(breaks = seq(45,65,10)) +
  # my_ggtheme_m() +
  theme(legend.position = "",
        panel.background = element_rect(fill = "white", color = "white"),
        panel.grid.major =  element_line(color = "white")
        ) +
  scale_colour_viridis(
    name="Average Gain of\nStock-Share Ratio (%)",
    limits = c(0,max(Eu_data$per_plot)),
    breaks = seq(0,max(Eu_data$per_plot),5),
    # option="magma",
    # direction = -1
   )+
  scale_fill_viridis(
    name="Average Gain of\nStock-Share Ratio (%)",
    limits = c(0,max(Med_data$per_plot)),
    breaks = seq(0,max(Med_data$per_plot),5),
    # option="magma",
    # direction = -1
  );Eu_map


## ------------------- ##
# Final Figure
## ------------------- ##

# gc()
# plot_all <- ggdraw() +
#       # map
#       draw_plot(Prop_map, x = 0, y = 0.45, width = 1, height = 0.58) +
#       # Lat America reg plor
#       draw_plot(Lat_am_map, x = 0.1, y = 0.08, width = 0.3, height = 0.4) +
#       # Europe reg plot
#       draw_plot(Eu_map, x = 0.35, y = 0.08, width = 0.3, height = 0.4) +
#       # Med regional plot
#       draw_plot(Med_map, x = 0.65, y = 0.08, width = 0.3, height = 0.4) +
#       draw_plot_label(label = c("a", "b"), 
#                       size = 20,
#                       x = c(0, 0), 
#                       y = c(1, 0.45)
#       ) #+
#       # draw_plot_label(label = c("Revenue (USD) | Catch (Tonnes)","(Million)"), 
#                       # size = 8,
#                       # x = c(0.325,0.485), 
#                       # y = c(0.31,0.29)
#       )
#     
#     
#     save_plot(
#       # paste(Figures_Path,"100_25_Bins_Value_Region.png",sep=""),
#       "test.png",
#       plot_all,
#       base_height = 8,
#       base_width = 8
#     )
  

```

##### Fig S2 (Histogram of change)

```{r hist_change}

 Prop_results %>% 
  gather("time_step","change",per_early,per_mid) %>% 
  filter(variable == "mean_eez" & 
           !is.na(change)
         ) %>%
ggplot() +
  geom_density(
               aes(
                 x = ifelse(change >= 100,100,change),
                 # x = change,
                 fill = ifelse(time_step == "per_early","q",time_step)
                 # fill = time_step,
                 
               ),
               # stat = "count",
               # alpha= 0.8,
               size=0.1,
               # position = "stack"
  ) +
  scale_y_continuous("Density",
                     # breaks = seq(0,90,10),
                     # limits = c(0,100)
  ) +
  scale_x_continuous("Percentage Change",
                     breaks = seq(-75,500,25)
  ) +
  my_ggtheme_p() +
  theme(legend.position = "right") +
  scale_fill_viridis(discrete = T, 
                     option = "plasma",
                     alpha = 0.5,
                     name = "Time Step", labels = c("Middle", "Early")
                     ) +
  coord_flip() +
  ggsave("./Figures/hist_change.png",
         width = 6,
         height = 6,
         units = "in"
  )

```

####  Year of Eergence Analysis

##### Histogram of Data

```{r histo,  eval = T, echo = T}

# First time a Species becomes emergent
Eme_Res %>% 
  filter(
    n_ens == 10#,
    # tresh == "tresh_one"
  ) %>% 
  group_by(tresh,taxon_key,emerging_yr) %>% 
  summarise(
    n_trans = length(unique(sf_eez_name))
  ) %>% 
  group_by(tresh,taxon_key) %>% 
  summarise(
    ntrans = min(emerging_yr)
  ) %>% 
  group_by(tresh,ntrans) %>% 
  summarise(
    n_taxa = length(unique(taxon_key))
  ) %>% 
  arrange(-n_taxa) %>% 
  # View()
  # group_by(tresh) %>% 
  # summarise(sum(n_taxa))
  ggplot() +
  geom_line(
    aes(
      x = ntrans,
      y = n_taxa,
      color = tresh
    )
  )


# EEZ, first time an EEZ has a emergent stock
Eme_Res %>% 
  filter(
    n_ens == 10#,
    # tresh == "tresh_one"
  ) %>% 
  group_by(tresh,sf_eez_name,emerging_yr) %>% 
  summarise(
    n_trans = length(unique(taxon_key))
  ) %>% 
  group_by(tresh,sf_eez_name) %>% 
  summarise(
    ntrans = min(emerging_yr)
  ) %>% 
  group_by(tresh,ntrans) %>% 
  summarise(
    n_taxa = length(unique(sf_eez_name))
  ) %>% 
  arrange(-n_taxa) %>% 
  View()
  # group_by(tresh) %>%
  # summarise(sum(n_taxa))
  # ggplot() +
  # geom_line(
  #   aes(
  #     x = ntrans,
  #     y = n_taxa,
  #     color = tresh
  #   )
  # )
  


# Numer of EEZs where stocks will emerge
stock_d_hist <- Eme_Res %>% 
  distinct(taxon_key,neighbour_id,tresh, .keep_all = TRUE) %>%
  group_by(emerging_yr,taxon_key,tresh) %>%
  summarise(n_tax = length(unique(sf_eez_name))) %>%
  # summarise(n()) %>% 
  mutate(
    level = "EEZs per Spp"
  )  %>% 
  ungroup() %>% 
  select(-taxon_key)


# Per EEZs
eez_d_hist <- Eme_Res %>% 
  distinct(taxon_key,neighbour_id,tresh, .keep_all = TRUE) %>%
  group_by(emerging_yr,sf_eez_name,tresh,neighbour_id) %>%  
  # summarise(n_tax = length(unique(taxon_key))) %>% 
  summarise(n()) %>% 
  mutate(
    level = "Spp per EEZ"
  ) %>% 
  ungroup() %>% 
  select(-sf_eez_name)

stock_d_hist %>% 
  bind_rows(eez_d_hist) %>% 
  filter(tresh != "NA") %>% 
  ggplot() +
  geom_density(
    aes(
      x = emerging_yr,
      fill = level
    ),
    stat = "count",
    alpha= 0.8,
    size=0.5,
  ) +
  scale_y_continuous("Frequency",
                     # breaks = seq(0,300,50),
                     # limits = c(0,300)
  ) +
  scale_x_continuous("Year of emergence",
                     # breaks = seq(2006,2100,25),
                     # limits = c(2000,2100)
  ) +
  my_ggtheme_p() +
  scale_fill_viridis(discrete = T) +
  facet_wrap(~tresh) +
  ggsave("./Figures/hist_freq.png",
         width = 6,
         height = 6,
         units = "in"
  )

```

##### Accumulative plots

```{r Time_lapse_plot,  eval = T, echo = T}

# Per Stock
stock_d <-  Eme_Res %>% 
  left_join(Neighbours) %>% 
    # distinct(taxon_key,neighbour_id, .keep_all = TRUE) %>% 
    group_by(taxon_key,tresh) %>% 
    summarise(
      taxon_emer = min(emerging_yr)
    ) %>% 
    group_by(taxon_emer,tresh) %>% 
  summarise(
    n_tax = n()
  ) %>% 
  group_by(tresh) %>% 
  mutate(
    com_sum = cumsum(n_tax),
    level = "Stock"
  )

  #  EEZ data
eez_d <-  Eme_Res %>% 
  left_join(Neighbours) %>% 
  filter(n_ens == 10) %>% 
    # distinct(eez_name,neighbour_id, .keep_all = TRUE) %>% 
    group_by(sf_eez_name,tresh) %>% 
    summarise(
      taxon_emer = min(emerging_yr)
    ) %>% 
    group_by(taxon_emer,tresh) %>% 
  summarise(
    n_tax = n()
  ) %>% 
  group_by(tresh) %>% 
  mutate(
    com_sum = cumsum(n_tax),
    level = "EEZ"
  )
  
# Plot Data
plot_data <- stock_d %>% 
  bind_rows(eez_d) %>% 
  filter(tresh != "NA") %>% 
  mutate(
    total = ifelse(level == "Stock",length(unique(Eme_Res$taxon_key)),length(unique(Eme_Res$eez_name))),
    per = com_sum/total*100
  ) ;plot_data

  # filter(emerging_yr >= 2020) %>% 
  ggplot() +
    geom_area(data = subset(plot_data, level == "Stock"),
              aes(
                x = as.numeric(taxon_emer),
                y = com_sum,
                fill = level
              ),
              alpha= 0.8,
              size=0.5,
              colour="black"
    )  +
    geom_area(data = subset(plot_data, level == "EEZ"),
              aes(
                x = taxon_emer,
                y = com_sum,
                fill = level
              ),
              alpha= 0.8,
              size=0.5,
              colour="black"
    ) +
    facet_wrap(~tresh) + 
    # Comment out for option A (Change plot name!!)
  #   geom_hline(yintercept = length(unique(Eme_Res$eez_name)), color = "grey",linetype = "dashed") +
  # geom_text(aes(label="Total number of EEZs", x = 2010, y = length(unique(Eme_Res$eez_name))+10), color = "grey70",size =3) +
  #   geom_hline(yintercept = length(unique(Eme_Res$taxon_key)), color = "grey",linetype = "dashed") +
  # geom_text(aes(label="Total number of Taxa", x = 2010, y = length(unique(Eme_Res$taxon_key))+10), color = "grey70",size =3) +
    scale_y_continuous("Cumulatuve Curve",
                       breaks = seq(0,600,50),
                       limits = c(0,600)
    ) +
    scale_x_continuous("Year of emergence",
                       breaks = seq(2005,2100,10),
                       limits = c(2005,2100)
    ) +
    my_ggtheme_p() +
    scale_fill_viridis(discrete = T) +
  ggsave("./Figures/figure_accumulative_curve_ab.png",
         width = 6,
         height = 6,
         units = "in"
  )
  
  
  ### Percentage accumulation
  
  # filter(emerging_yr >= 2020) %>% 
  ggplot() +
    geom_area(data = subset(plot_data, level == "Stock"),
              aes(
                x = as.numeric(taxon_emer),
                y = per,
                fill = level
              ),
              alpha= 0.8,
              size=0.5,
              colour="black"
    )  +
    geom_area(data = subset(plot_data, level == "EEZ"),
              aes(
                x = taxon_emer,
                y = per,
                fill = level
              ),
              alpha= 0.8,
              size=0.5,
              colour="black"
    ) +
    scale_y_continuous("Cumulatuve Curve",
                       breaks = seq(0,100,25),
                       limits = c(0,100)
    ) +
    scale_x_continuous("Year of emergence",
                       breaks = seq(2005,2100,15),
                       limits = c(2005,2100)
    ) +
    my_ggtheme_p() +
    scale_fill_viridis(discrete = T) +
    facet_wrap(~tresh) + 
  ggsave("./Figures/Fig4.png",
         width = 8,
         height = 8,
         units = "in"
  )
  
```

##### Scatter plots

```{r Scatter_plot,  eval = T, echo = T}

 data_stock <- Eme_Res %>% 
  filter(
    n_ens == 10,
    emerging_yr >= 2020
  ) %>% 
  group_by(emerging_yr,eez_name) %>% 
  summarise(
    tax_n = length(unique(taxon_key))
    ) %>% 
  group_by(emerging_yr) %>% 
  summarise(emerging_tax = sum(tax_n))

data_eez <- Eme_Res %>% 
  filter(
    n_ens == 10,
    emerging_yr >= 2020
  ) %>% 
  group_by(emerging_yr,taxon_key) %>% 
  summarise(
    eez_n = length(unique(eez_name))
    ) %>% 
    group_by(emerging_yr) %>% 
  summarise(emerging_eez = sum(eez_n))


data_stock %>% 
  left_join(data_eez,
            by = "emerging_yr") %>% 
  ggplot() +
  geom_point(
    aes(
      x = emerging_eez,
      y = emerging_tax,
      fill = emerging_yr,
      colour = emerging_yr
    )
  )
  
```


##### Temperature gradient

##### Fun `GetEnvData`

```{r get_env_data, eval = T, echo = T}

getEnvVar=function(yr,ModelRCP,RCP,Variable){
  
  if(ModelRCP == "IPSL"){
    ModelRCP = "IPSL-CM5A-MR"
    Filepath <- paste("/Volumes/DATA/DATA/Environmental data/Model Climate data/CMIP5/txt CMIP5/Reformatted",ModelRCP,RCP,"",sep="/")
  }
  
  
  if(ModelRCP == "MPI"){
    ModelRCP = "MPI-ESM-MR"
    Filepath <- paste("/Volumes/DATA/DATA/Environmental data/Model Climate data/CMIP5/txt CMIP5/Reformatted",ModelRCP,RCP,"",sep="/")
  }
  
  if(ModelRCP == "GFDL"){
    
    if(RCP == "rcp26"){
      ModelRCP <- "GFDL26"
    }else{
      ModelRCP <- "GFDL85"
    }
    Filepath <- paste("Z:/JULIANO_NEYMAR/PristineSeasData/Climate",ModelRCP,"",sep="/")
  }
  
  
  if(Variable == "Ice"){
    
    Bottom <- paste("IceExt_",yr,".txt",sep="")
    
  }
  
  if(Variable == "Temperature"){
    
    Bottom = paste("SST_",yr,".txt",sep="")
    
  }
  
  if(Variable == "Salinity"){
    # Bottom
    Bottom = paste("Salinity_btm_",yr,".txt",sep="")
    
  }
  
  Read_me <- paste(Filepath,Bottom,sep="")[1]
  Bottom_Data <- read.csv(Read_me,header=F)
  
  # Retrun
  
  getTemp <- Bottom_Data 
}

Years <-seq(1951,2100,1)

for(y in 1:length(Years)){
        Data <- getEnvVar(yr = Years[y],
                          Model = "GFDL",
                          Variable = "Temperature",
                          RCP = "rcp85"
        )
        
        if(y == 1){
          
          F_BData <- Data[1]
          colnames(F_BData) <- Years[1]
      
        }else{
          
          F_BData <- cbind(F_BData,Data[1])
          colnames(F_BData)[y] <- Years[y]
        }
}


F_BData <- F_BData %>% 
          rowid_to_column("index") %>% 
  gather("year","temp",-index) %>% 
   mutate(temp = ifelse(temp == -9999,NA,temp)) %>% 
  group_by(year) %>% 
  summarise(
    mean_temp = mean(temp,na.rm=T)
  ) %>% 
  write_csv(.,
            "SST_data.csv")

```


```{r temp_plot, eval = T, echo = T}

### NEED TO RUN TIME LAPSE CHUNK FIRST TO GET ACCUMULATIVE DATA

# Get sst_data
sst_data <- my_path("D",T,"Climate","SST_data.csv",read = T)

sst_hist <- sst_data %>% 
  filter(year < 2000) %>% 
  group_by() %>% 
  summarise(hist_sst =mean(mean_temp)) %>% 
  pull()

sst_change <- sst_data %>%
  filter(year > 2020) %>% 
  mutate(chng = round(mean_temp-sst_hist,2))


  
  # Plot Data
stock_d %>% 
  bind_rows(eez_d) %>% 
  filter(taxon_emer >= 2020) %>% 
  rename(year = taxon_emer) %>% 
  left_join(sst_change) %>% 
  ggplot() +
  geom_line(
    aes(
      x = chng,
      y = com_sum,
      colour = level
    )
  ) +
  geom_hline(yintercept = length(unique(Eme_Res$eez_name)), color = "grey",linetype = "dashed") +
  geom_text(aes(label="Total number of EEZs", x = 0.5, y = length(unique(Eme_Res$eez_name))+10), color = "grey70",size =3) +
    scale_y_continuous("Cumulatuve Curve",
                       breaks = seq(0,450,50),
                       limits = c(0,500)
    ) +
    scale_x_continuous("Change in SST (C)",
                       breaks = seq(0,2,0.2),
                       limits = c(0.3,2.3)
    ) +
    my_ggtheme_p() +
    scale_colour_viridis(discrete = T) +
  ggsave("./Figures/figure_temp.png",
         width = 6,
         height = 6,
         units = "in"
  )
  
```


```{r Scatter_plot,  eval = T, echo = T}




 data_stock <- Eme_Res %>% 
  filter(
    n_ens == 10,
    emerging_yr >= 2020
  ) %>% 
  group_by(emerging_yr,eez_name) %>% 
  summarise(
    tax_n = length(unique(taxon_key))
    ) %>% 
  group_by(emerging_yr) %>% 
  summarise(emerging_tax = sum(tax_n))

data_eez <- Eme_Res %>% 
  filter(
    n_ens == 10,
    emerging_yr >= 2020
  ) %>% 
  group_by(emerging_yr,taxon_key) %>% 
  summarise(
    eez_n = length(unique(eez_name))
    ) %>% 
    group_by(emerging_yr) %>% 
  summarise(emerging_eez = sum(eez_n))


data_stock %>% 
  left_join(data_eez,
            by = "emerging_yr") %>% 
  rename(year = emerging_yr) %>% 
  left_join(sst_data) %>% 
  ggplot() +
  geom_point(
    aes(
      x = mean_temp,
      y = emerging_eez,
      fill = year,
      colour = year
    )
  )
  
```

##### Fig. 2 Mapping the time of emergence

###### Just mean time

```{r emergence_map, eval = T}

# Per EEZs
Eez_d_hist <- Eme_Res %>% 
  group_by(eezid ,sau_fishing_entity,tresh) %>% 
  # summarise(n_tax = length(unique(taxon_key))) %>% 
  summarise(
    mean_yr = mean(emerging_yr,na.rm=T),
    sd_yr = sd(emerging_yr,na.rm=T),
    n_taxa = length(unique(taxon_key))
    ) %>% 
  gather("metric","value",mean_yr:n_taxa) %>% 
  # filter(metric != "n_taxa") %>% 
  mutate(
    reverse = abs(value-2100)  + 2000
  )

# Estimate the value (catch and USD) of emerging species
Eme_value_data <- Eme_Res %>% 
  group_by(sau_fishing_entity,fishing_entity_id,tresh,taxon_key) %>% 
  summarise(n()) %>% 
  left_join(Sau_data,
            by = c("fishing_entity_id","taxon_key")) %>% 
  filter(!is.na(variable)) %>% 
  group_by(sau_fishing_entity,fishing_entity_id,tresh,variable) %>% 
  summarise(
   sum_value = sum(value,na.rm=T),
    n_taxa = length(unique(taxon_key)) 
  )
  
# Total value of each fishing nation

Total_value <- Sau_data %>% 
  group_by(fishing_entity_id,variable) %>% 
  summarise(tot_value= sum(value,na.rm=T))


Value_map_data <- Eme_value_data %>% 
  left_join(Total_value,
            by = c("fishing_entity_id","variable")) %>% 
  mutate(participation = (sum_value/tot_value)*100)


# Per fishing entity

fish_d_hist <- Eme_Res %>% 
  group_by(sau_fishing_entity,tresh) %>% 
  # summarise(n_tax = length(unique(taxon_key))) %>% 
  summarise(
    value = length(unique(taxon_key))
    ) %>% 
  filter(!is.na(sau_fishing_entity))

World_map_nemer <- World_map %>%
  left_join(Value_map_data,
            by = c("sau_fishing_entity","fishing_entity_id")
  ) %>% 
  filter(!is.na(participation))

grey_land <- World_map %>% 
  filter(!fishing_entity_id %in% World_map_nemer$fishing_entity_id) %>% 
  filter(sovereignt != "Antarctica")

grey_eez <- World_eez_sf %>% 
  filter(!eezid %in% Eez_d_hist$eezid)


for(i in 1:2){
  
  tresh_list <- c("Tresh_one","Tresh_two")
  name_save <- paste("./Figures/emer_map_lat_",tresh_list[i],".png",sep = "")
  
  ## --------------- ##
  # Latitudinal plot
  ## --------------- ##
  
  ### Random plot

Eez_hist <- Eme_Res %>% 
  group_by(eezid,eez_name = sf_eez_name) %>% 
  left_join(Eez_centroid) %>% 
  filter(tresh == tresh_list[i]) %>% 
  group_by(latitude) %>% 
  summarise(
    number = n()
  ) %>% 
  group_by() %>% 
  mutate(RMean = rollmean(x = number, 
                          10, 
                          align = "center", 
                          fill = number
  )
  ) %>% 
  mutate(lab="lab") %>% 
  ggplot() +
  geom_area(
    aes(
      x = latitude,
      y = RMean,
      fill = lab,
      color = lab
    )
  ) +
  coord_flip() +
  scale_x_continuous("",
    limits = c(-50,80),
    breaks = c(-50,0,50,80)
  ) +
  scale_y_continuous(
    "Emerging stocks",
    limits = c(0, 124),
    breaks = c(0,62,124)
    
  ) +
  scale_fill_viridis(option="magma", discrete = T, begin = 0.7) +
  scale_color_viridis(option="magma", discrete = T, begin = 0.7) +
  theme_minimal() + 
  theme(
    panel.background = element_rect(fill = "white", colour = "white"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text = element_text(size = 12, colour="black"),
    axis.title.x = element_text(size = 12, colour="black", face = "bold"),
    legend.position = ""
  );Eez_hist
  
  ## --------------- ##
  # Map
  ## --------------- ##

  World_map_part <- World_map_nemer %>% 
    filter(
      tresh ==  tresh_list[i], 
      variable == "value"
    )
  
  map <- World_eez_sf %>% 
    left_join(Eez_d_hist,
              by = "eezid") %>% 
    filter(tresh == tresh_list[i],
           metric == "mean_yr") %>% 
    ggplot() +
    geom_sf(
      aes(
        fill = reverse
      ),
      color =  "white",
      size = 0.1
    ) +
    # Inlcude the participation of species
    geom_sf(data = World_map_part,
            aes(fill = participation+2000),
            color =  "white",
            size = 0.1
            ) +
    # grey maps
    geom_sf(data = grey_land, aes(),fill = "grey50", color =  "white",size = 0.1) +
    geom_sf(data = grey_eez, aes(),fill = "grey50", color =  "white",size = 0.1) +
    # Set Participation labels
    annotate("text", 
             x =-135,
             y = -69,
             label = "Participation (%)", 
             color="black", 
             size=4, 
             angle=0, 
             fontface="bold",
             hjust=0) +
    annotate("text", 
             x = c(-76,-35,6,48,88),
             y = -69,
             # x =(c(-8500000,-3000000,2500000,7500000,12800000)),
             # y = -9050000,
             label = c(0,25,50,75,100), 
             color="black", 
             size=4, 
             angle=0, 
             # fontface="bold",
             hjust=0) +
    # Set ToE labels
    annotate("text", 
             x =-135,
             y = -85,
             label = "Time of Emergence",
             color="black", 
             size=4, 
             angle=0, 
             fontface="bold",
             hjust=0) +
    annotate("text", 
             x = c(-79,-39,3,45,87),
             y = -85,
             label = seq(2100,2000,-25), 
             color="black", 
             size=4, 
             angle=0, 
             # fontface="bold",
             hjust=0) +
    scale_fill_viridis("",
      limits = c(2000,2100),
      breaks = seq(2000,2100,25),
      labels = c("","","","","")#,
      # direction = -1
    ) +
    # geom_hline(yintercept = c(-50,0,50,80)) +
    my_ggtheme_m() +
    theme(
      legend.box.margin = margin(t = -64, l = 229),
      legend.text = element_blank(),
      legend.key.width = unit(5, "line")
    )
  
  
  ## --------------- ##
  # Combine plots and save them
  ## --------------- ##
  
  p <- ggdraw() +
    # ToE Latitudinal plot
    draw_plot(Eez_hist, x = 0.873, y = 0.13, width = 0.124, height = 0.77) +
    # Time of Emergence Map
    draw_plot(map, x = 0, y = 0, width = 0.95, height = 1)
  
  save_plot(
    name_save,
    p,
    base_height = 6,
    base_width = 12
  )

}


```

##### Fig. 3. Bubble plot

```{r, buble_plot, eval = F, echo = F}

Buble_data <- Eez_d_hist %>% 
  filter(metric == "mean_yr") %>% 
  group_by(sau_fishing_entity,tresh) %>% 
  summarise(mean_yr = mean(value)) %>% 
  left_join(Eme_value_data,
            by = c("sau_fishing_entity","tresh")) %>% 
  filter(tresh == tresh_list[i],
         variable == "value") %>% 
  mutate(
    weight_toe = sum_value/mean_yr,
    sum_value_mi = sum_value/1000000000,
         logvalue = log10(sum_value)
         ) %>%   # Billion usd
  left_join(Matching_names,
            by = c("sau_fishing_entity","fishing_entity_id")) %>% 
  distinct(sau_fishing_entity,.keep_all = TRUE) %>% 
  filter(!is.na(un_geo_region)) %>% 
  ungroup() %>% 
  mutate(
    sau_fishing_entity = ifelse(sum_value_mi >= 1 & !sau_fishing_entity %in% c("Spain"), paste(sau_fishing_entity,"*",sep = ""),sau_fishing_entity)
  )


# Labels Data

Labels_data <- tibble(
  x = c(2020,2040,2070),
  y = c(0.3,0.3,9.1),
  label = c("Early emergence", "Late emergence","Fisheries over the 75 percentile")
)


# Plot the bubbles!

ggplot(Buble_data) +
  geom_point(
    aes(
      x = mean_yr,
      # y = sum_value_mi,
      y = logvalue,
      size = n_taxa,
      colour = un_geo_region
    ),
    alpha = 0.7
  ) +
  geom_vline(xintercept = 2030, color = "grey90", size = 0.5) +
  geom_hline(yintercept = 9, color = "grey90", size = 0.5)  +
  geom_label_repel(data = subset(Buble_data, sum_value_mi >= 1),
                   aes(
                     x = mean_yr,
                     # y = sum_value_mi,
                     y = logvalue,
                     label = sau_fishing_entity
                   ),
                   arrow = arrow(length = unit(0.009, "npc"),
                                 type = "closed",
                                 ends = "first"),
                   force = 3,
                   box.padding = 2,
                   fill = "NA"

  ) +
  geom_text(data = Labels_data,
    aes(
      x = x,
      y = y,
      label = label
    ),
    size = 3,
    color = "grey30"
  ) +
  # scale_fill_viridis(discrete = F)
  scale_color_viridis(name="Region",
                      discrete = T) +
  scale_x_continuous("Average time of emergence",
                     limits = c(2000,2080),
                     breaks = seq(2000,2080,10)
  ) +
  scale_y_continuous("Fishing revenue (log10)",
                     limits = c(3,12),
                     breaks = seq(3,12,3),
                     expand = c(0,0)
  ) +
  scale_size("Number of\nemerging taxa") +
  ggsave("./Figures/bubble_plot.png",
         width = 8,
         height = 8,
         units = "in"
  )

```


### Species level analysis

#### Demersal Vs Pelagic

```{r deme_pela, eval = F, echo =F}

Dem_pel <- Eme_Res %>% 
  filter(tresh == "Tresh_one",
         !is.na(un_sub_region)) %>% 
  left_join(Spp_depth) 


Dem_pel_mean <- Dem_pel %>% 
  group_by(dem_pel) %>% 
  summarise(mean  = mean(emerging_yr)) 


ggplot(Dem_pel) +
  geom_boxplot(
    aes(
      x = reorder(dem_pel,emerging_yr),
      y = emerging_yr,
      fill = un_sub_region
    )
  ) +
  geom_line(data = Dem_pel_mean,
    aes(
      x = dem_pel,
      y = mean
    )
)


ggplot(Dem_pel) +
  geom_boxplot(
    aes(
      x = reorder(dem_pel,emerging_yr),
      y = emerging_yr
    )
  ) +
  facet_wrap(~un_sub_region)

```

### Tab.1 Explain the ToE

```{r multiple_reg, eval = F, echo = F}

# Possible explanatory variables

## Habitat association (DemersPelag)
## Dem Vs Pelagic (Dem_pel)
## SST time of Emer (Toe_sst)
## Stock Status [FishForVisa] (Catch_trend)
## Biogeographic location (Biogeo_reg)


# AIC value; model between predictive capacity and complexity (i.e., number of explanatory variables) is given by the model with lowest AIC value

# -------------------------------- #
#### Prepare data
# -------------------------------- #

Lm_data <- Eme_Res %>% # 19728
  filter(tresh == "Tresh_one") %>% # 11490
  left_join(Spp_depth) %>% 
  select(taxon_key,tresh,sf_eez_name,sau_fishing_entity,fishing_entity_id,emerging_yr,eezid,dem_pel) %>% 
  left_join(Toe_temp,
            by = c("eezid","tresh")
            ) %>% 
  left_join(Catch_trend,
            by = c("taxon_key","sau_fishing_entity","fishing_entity_id")
            ) %>% # 11492
  left_join(Eez_biogeo,
            by = "eezid") %>% 
  left_join(Spp_env_pref,
            by = "taxon_key") %>% 
  left_join(Eez_centroids,
            by = "eezid") %>% 
  mutate(latitude = abs(latitude))


# -------------------------------- #
#### Build models
# -------------------------------- #

# Model 1; all variables
M_all_var <- lm(emerging_yr ~ sst_toe + bot_toe + status + biome + dem_pel + DemersPelag, data = Lm_data)

all_sum <- summary(M_all_var)
all_aic <- AIC(M_all_var)
all_r <-  all_sum$adj.r.squared

# Model 2; non demPel
M2 <- lm(emerging_yr ~ sst_toe + bot_toe + status + biome + dem_pel, data = Lm_data)

M2_sum <- summary(M2)
M2_aic <- AIC(M2)
M2_r <-  M2_sum$adj.r.squared


# Model 3; non biome
M3 <- lm(emerging_yr ~ sst_toe + bot_toe + status + dem_pel + DemersPelag, data = Lm_data)

M3_sum <- summary(M3)
M3_aic <- AIC(M3)
M3_r <-  M3_sum$adj.r.squared

# Model 4; non status
M4 <- lm(emerging_yr ~ sst_toe + bot_toe + biome + dem_pel + DemersPelag, data = Lm_data)

M4_sum <- summary(M4)
M4_aic <- AIC(M4)
M4_r <-  M4_sum$adj.r.squared

# Model 5; non sst
M5 <- lm(emerging_yr ~ status + bot_toe + biome + dem_pel + DemersPelag, data = Lm_data)

M5_sum <- summary(M5)
M5_aic <- AIC(M5)
M5_r <-  M5_sum$adj.r.squared

# Model 6; all + basin
M6 <- lm(emerging_yr ~ sst_toe + bot_toe + status + biome + dem_pel + DemersPelag, data = Lm_data)

M6_sum <- summary(M6)
M6_aic <- AIC(M6)
M6_r <-  M6_sum$adj.r.squared

# Model 7; Categories instead of status
M7 <- lm(emerging_yr ~ sst_toe + bot_toe + category + biome + dem_pel + DemersPelag, data = Lm_data)

M7_sum <- summary(M7)
M7_aic <- AIC(M7)
M7_r <-  M7_sum$adj.r.squared

# Model 8; All variables + ccentroid lat
M8 <- lm(emerging_yr ~ sst_toe + bot_toe + category + biome + DemersPelag + latitude, data = Lm_data)

M8_sum <- summary(M8)
M8_aic <- AIC(M8)
M8_r <-  M8_sum$adj.r.squared



tibble(
  "model" = paste("M",seq(1,8,1),sep=""),
  "AIC" = c(all_aic,M2_aic,M3_aic,M4_aic,M5_aic,M6_aic,M7_aic,M8_aic),
  "rsquared" = c(all_r,M2_r,M3_r,M4_r,M5_r,M6_r,M7_r,M8_r)
)


# UNIDAS 20282659


# The Winner is M8!



stargazer(M8, title = "Results", align=TRUE)

```


## Troubleshooting

### Weird connections from Australia

```{r fig_map_Juan, eval = F, echo =F}

##_----------------------- #
# Checking on China and Indonesia
# Probably due to dispute territories

Neighbours <- my_path("D", extra_path = "Spatial/", name="Neighbours_eez_id.csv", read = TRUE) %>% 
  clean_names()

# 
# Neighbours %>% 
#   filter(eez_name == "China") %>% 
#   pull(eez_neighbour) %>% 
#   unique()

##_----------------------- #


# Get the center poligon of each EEZ for map source/target
coords <- as.data.frame(st_centroid(World_eez_sf)) %>% 
  ungroup() %>% 
  select(eez_name,geometry) %>% 
  separate(col = geometry, into = c("longitude", "latitude"), sep = "\\,") %>% 
  # Manually fix issues
  mutate(
    longitude = ifelse(
      eez_name == "Fiji", 178.065033,
      ifelse(eez_name == "Tuvalu",177.6493,
             ifelse( eez_name == "New Zealand",174.8860,
                     ifelse( eez_name == "USA (Alaska, Subarctic)",-145.8860,longitude
                     )
             )
      )
    )
  )

# Remove "c()"
coords$longitude <- gsub("\\(","",coords$longitude)
coords$longitude <- gsub("c","",coords$longitude)
coords$latitude <- gsub(")","",coords$latitude)

coords <- coords %>% 
  mutate_at(vars(longitude,latitude),as.numeric)

# Prepare data from results
Test_Data <- results %>% 
  # get coords for sources
  left_join(coords,
            by = "eez_name") %>%
  rename(source = eez_name,
         start_lon = longitude,
         start_lat = latitude,
         eez_name=eez_neighbour) %>% 
  # get coords for targets
  left_join(coords,
            by = "eez_name") %>% 
  rename(target = eez_name,
         end_lon = longitude,
         end_lat = latitude) %>% 
  ungroup() %>% 
  # Plot miscs
  mutate(
    per_mid = ifelse(is.na(per_mid),0,per_mid)
  ) %>% 
  drop_na() %>% 
  filter(
    # per_mid >= 20,
    variable == "mean_spp",
  )


# Convert to data to spatial
network_data_sf <- Test_Data %>%
  select(start_lon, start_lat, end_lon, end_lat) %>% 
  purrr::transpose() %>% 
  purrr::map(~ matrix(flatten_dbl(.), nrow = 2, byrow = TRUE)) %>% 
  purrr::map(st_linestring) %>%
  st_sfc(crs = 4326) %>%
  st_sf(geometry = .)%>%
  bind_cols(Test_Data) %>%
  select(everything(), geometry) %>% 
  # Set circles ('cus the world is not flat!)
  st_segmentize(units::set_units(100, km)) %>% 
  mutate(geometry = (geometry + c(180,90)) %% c(360) - c(180,90)) %>% 
  st_wrap_dateline(options = c("WRAPDATELINE=YES",  "DATELINEOFFSET=180"), quiet = TRUE) %>% 
  sf::st_sf(crs = 4326)

#  unpack the coordinates of each feature 
coord_data <- as.data.frame( st_coordinates(st_cast(network_data_sf,"MULTILINESTRING")$geometry))

c(network_data_sf$line_id, network_data_sf$coords) %<-% (
  coord_data %>% 
    rename(subline_id = L1) %>%   
    nest(-L2)
)

# Create data path for line connections
paths <- network_data_sf %>% 
  sf::st_set_geometry(NULL) %>% 
  unnest() %>% 
  mutate_at(vars(X,Y), round,2)

# Plot it!

country <- c("Fiji","Solomon Isl.","Tuvalu")

ggplot() +
  geom_sf(
    # data = subset(world_map,name %in% country),
    data = world_map,
    size = 0.1, fill = "gray90", col = "gray90") +
  geom_sf(
    # data = subset(World_eez_sf, eez_name %in% country),
    data = World_eez_sf,
    size = 0.1, fill = "white", col = "gray70") +
  geom_point(data = Test_Data,
             # data = subset(Test_Data, source %in% country & target %in% source),
             aes(start_lon,
                 start_lat,
                 col = per_mid),
             size = 0.1,
             col = "black",
             # shape = 21,
             stroke = 1.5) +
  geom_path(data = paths,
            # data = subset(paths, source %in% country),
            aes(X, Y,
                group = interaction(line_id,subline_id),
                col = per_mid
            ),
            size = 0.3,
            arrow = arrow(length = unit(0.009, "npc")),
            show.legend = NA) +
  # geom_sf_text(data = subset(World_eez_sf, eez_name %in% country),
  #              aes(label =eez_name),
  #              size = 2) +
  # geom_text(data = subset(Test_Data, source %in% country),
  #              aes(start_lon,
  #                start_lat,
  #                label = paste(source,"to",target)
  #              ),
  #              size = 2) +
  # geom_text_repel(data = Test_Data,
  #   aes(start_lon,
# start_lat,
# label = paste(source,"to",target)
# )
# )+
ggtheme_map() +
  scale_colour_gradientn("Gain of Stock-Share Ratio (%)",
                         colours = wesanderson::wes_palette("Zissou1", 100, type = "continuous"),
                         limits = c(0,25),
                         breaks = seq(0,25,5)
  )

```


# Old Code


```{r TransIndex, eval = F, echo = F}

TransIndex <- function(Spp,year, data_type = "Catch",ensemble_list,path,Neighbours,eez_centroid){
  
  # ----------------- #
  # Get Species Centrodis
  #  ---------------- #
  
  # Get model data from spps
  Spp_Dist <- bind_rows(
    lapply(
      ensemble_list,
      dbem_import,
      taxon_key = Spp,
      year = year,
      data_type = data_type,
      path = path
    )
  )
  
  
  #### Control for Spp id so I can fix problems
  
if(file.exists("~/Desktop/spp_df.csv") == FALSE){
  spp_df <- tibble() %>% 
    write_csv(.,
            "~/Desktop/spp_df.csv")
}

  suppressMessages(
    spp_df <- read_csv("~/Desktop/spp_df.csv")
  )
  spp_df <- tibble(Spp) %>% 
    bind_rows(spp_df) %>% 
    write_csv(.,
              "~/Desktop/spp_df.csv")
  
  
  #____________ Selecting only the transboundary nature of the species _________ #
  Trans_Spp <- Spp_Dist %>%
    left_join(index_code,
              by= "index") %>% 
    filter(!is.na(value)) %>% 
    semi_join(Transboundary_spp, # filter only transboundary cases
              by = c("taxon_key","eez_name")
    )
  
  # Step
  nr <- nrow(Trans_Spp)
  if(nr > 0){
    

    # Filter eez by those transboundary
  unique_eez <- unique(Trans_Spp$eez_name)
  
  Neighbours_combo <- Neighbours %>% 
    filter(eez_name %in% unique_eez,
           eez_neighbour %in% unique_eez)
    
    
    # Get the centroid of each country
    EEZ_centroid <- eez_centroid %>% 
      filter(eez_name %in% Trans_Spp$eez_name) %>% 
      mutate(taxon_key = Spp)
    
    
    Ids <- unique(Neighbours_combo$neighbour_id)
    
  corefx <- function(Ids){  
    
      EEZ_ids <- Neighbours_combo %>% 
        filter(neighbour_id == Ids)
      
      Sub_Trans_Spp <- Trans_Spp %>% 
        filter(eez_name %in% EEZ_ids$eez_name)
      
      Sub_EEZ_centroid <- EEZ_centroid %>% 
        filter(eez_name %in% EEZ_ids$eez_name)
      
      # Centroid is defined as the tile with the higest species value
      Centroids <- Sub_Trans_Spp %>% 
        left_join(EEZ_ids, by = "eez_name") %>% 
        group_by(taxon_key,year,ensemble,neighbour_id) %>%  # for whole distribution
        top_n(1,value) %>% 
        distinct(value,year, .keep_all = TRUE) %>%  # removes duplicates when tile is in between EEZs
        left_join(Sub_EEZ_centroid, by = "taxon_key") %>%
        select(eez_name =eez_name.y, everything() ,-eez_name.x)
      
      # Estimate distances between spp centroid and EEZ centroid
      Distance_Data <- Centroids %>%
        rename(
          catch_lon = lon,
          catch_lat = lat,
          eez_lon = longitude,
          eez_lat= latitude
        ) %>% 
        # Estimate the distance between centriods
        mutate(
          distance = geodist(eez_lon, eez_lat, catch_lon, catch_lat, units="km")
        ) %>% 
        select(taxon_key,eez_name,neighbour_id,ensemble,year,distance)
      
      # Historical mean and sd of distance
      historical <- Distance_Data %>%
        filter(year <= 2000) %>%
        ungroup() %>%
        group_by(taxon_key,ensemble,eez_name,neighbour_id) %>%
        summarise_at(vars("distance"),
                     c(hd_temp_mean=mean,
                       hd_temp_sd=sd)
        )
      
      
      # Future results
      future <- Distance_Data %>% 
        filter(year > 2000)
      
      # Transboundary Index
      Trans_index <- Distance_Data %>% 
        left_join(historical,
                  by = c("taxon_key","eez_name","ensemble","neighbour_id")
        ) %>%
        # Re arrenging table for mutate
        gather("variable","value",distance:hd_temp_sd) %>%
        ungroup()
      
      
      Partial <- Trans_index %>% 
        mutate(
          names = ifelse(eez_name ==Sub_EEZ_centroid$eez_name[1],paste("Country_A",variable,sep="_"),paste("Country_B",variable,sep="_"))
        ) %>%
        select(-eez_name,-variable) %>%
        spread(names,value) %>% 
        # mutate index
        mutate(
          trans_index = (Country_A_distance/Country_A_hd_temp_sd - Country_B_distance/Country_B_hd_temp_sd)^2
        ) %>% 
        group_by(taxon_key,ensemble,neighbour_id) %>% 
        mutate(RMean = rollmean(x = trans_index, 
                                10, 
                                align = "right", 
                                fill = trans_index)
        ) %>% 
        filter(year > 1960) %>% 
        select(taxon_key,neighbour_id,year,ensemble,trans_index,RMean)
      
      # Average of 10 years mean of ensemble members results
      mean_sd_index <- Partial %>% 
        group_by(taxon_key,year,neighbour_id) %>% 
        summarise_at(vars("RMean"),
                     c(trend=mean,
                       ensemble_sd=sd)
        )
      
      # Estimate noice from ensemble members
      historic_sd <- mean_sd_index %>% 
        filter(year < 2000) %>% 
        group_by(taxon_key) %>% 
        summarise_at(vars("trend"),
                     c(hist_mean=mean,
                       noise=sd)
        )
      
      
      # Plot the result, bruh
      # ggplot() +
      #   geom_line(data = mean_sd_index,
      #             aes(
      #               x = year,
      #               y = trend
      #             )
      #   ) +
      #   geom_ribbon(data = mean_sd_index,
      #               aes(x=year,
      #                   ymin=historic_sd$hist_mean-historic_sd$noise,
      #                   ymax=historic_sd$hist_mean+historic_sd$noise),
      #               alpha = 0.5,
      #               fill = "grey50"
      #   ) +
      #   geom_line(data = mean_sd_index,
      #             aes(
      #               x = year,
      #               y = historic_sd$hist_mean
      #             ),
      #             colour = "grey50"
      #   ) +
      #   geom_point(data = subset(mean_sd_index, trend > (historic_sd$hist_mean+historic_sd$noise) | trend < (historic_sd$hist_mean-historic_sd$noise)),
      #              aes(
      #                x = year,
      #                y = trend,
      #                colour = "red",
      #              ),
      #              shape = 1,
      #              size = 3
      #   ) +
      #   geom_vline(xintercept = 2000,colour="blue",alpha = 0.5) +
      #   theme_classic()
      
      # #     
      Final_Result <- mean_sd_index %>%
        filter(year > 2000,
               trend > (historic_sd$hist_mean+historic_sd$noise) |
                 trend < (historic_sd$hist_mean-historic_sd$noise)
        ) %>%
        group_by(taxon_key,neighbour_id) %>%
        summarise(emerging_yr= min(year)) %>%
        left_join(EEZ_ids) %>%
        ungroup() %>%
        select(taxon_key,eez_name,eez_neighbour,emerging_yr)
      
      
      # if(i == 1){
      #   f_df <- Final_Result
      # }else{
      #   f_df <- bind_rows(f_df,Final_Result)
      # }
    return(Final_Result)
      }
    
  
  x <- bind_rows(
    mclapply(Ids,corefx)
  )
    # return(f_df)
    
  }else{
    
    print("no share data")
    
    x <- tibble(
      taxon_key = Spp,
      eez_name = NA,
      emerging_yr = NA
    )
    
  }
  
  return(x)

}

 
#  #One spp works 
# suppressMessages(
# TransIndex(Spp = 600006,
#              year,
#              data_type = "Catch",
#              ensemble_list,
#              path,
#              Neighbours = Neighbours,
#              eez_centroid)
# Multiple spp

# spp_list <- c(600004,
#               600005,
#               600245,
#               600006
#               )
# 
# suppressMessages(
#   suppressWarnings(
#     Test <- bind_rows(
#       lapply(spp_list,
#              TransIndex,
#              year,
#              data_type = "Catch",
#              ensemble_list,
#              path,
#              Neighbours,
#              eez_centroid
#       )
#     )
#   )
# )


```

###### With relation to neighbours

```{r time_emergence_map,  eval = T, echo = T}


##_----------------------- #
# Checking on China and Indonesia
# Probably due to dispute territories

Neighbours <- my_path("D", extra_path = "Spatial/", name="Neighbours_eez_id.csv", read = TRUE) %>% 
  clean_names()

# 
# Neighbours %>% 
#   filter(eez_name == "China") %>% 
#   pull(eez_neighbour) %>% 
#   unique()

##_----------------------- #


# Get the center poligon of each EEZ for map source/target
coords <- as.data.frame(st_centroid(World_eez_sf)) %>% 
  ungroup() %>% 
  select(eez_name,geometry) %>% 
  separate(col = geometry, into = c("longitude", "latitude"), sep = "\\,") %>% 
  # Manually fix issues
  mutate(
    longitude = ifelse(
      eez_name == "Fiji", 178.065033,
      ifelse(eez_name == "Tuvalu",177.6493,
             ifelse( eez_name == "New Zealand",174.8860,
                     ifelse( eez_name == "USA (Alaska, Subarctic)",-145.8860,longitude
                     )
             )
      )
    )
  )

# Remove "c()"
coords$longitude <- gsub("\\(","",coords$longitude)
coords$longitude <- gsub("c","",coords$longitude)
coords$latitude <- gsub(")","",coords$latitude)

coords <- coords %>% 
  mutate_at(vars(longitude,latitude),as.numeric)

# Prepare data from results
Test_Data <- Eme_Res %>% 
  filter(
    n_ens == 10#,
    # emerging_yr >= 2020
  ) %>% 
  group_by(eez_name,eez_neighbour,emerging_yr) %>% 
  summarise(
    n_tax = length(unique(taxon_key))
  ) %>% 
  filter(
    emerging_yr <= 2050
  ) %>%
  group_by(eez_name,eez_neighbour) %>% 
  summarise(
    n_tax_emer = sum(n_tax)
  ) %>% 
  # get coords for sources
  left_join(coords,
            by = "eez_name") %>%
  rename(source = eez_name,
         start_lon = longitude,
         start_lat = latitude,
         eez_name=eez_neighbour) %>% 
  # get coords for targets
  left_join(coords,
            by = "eez_name") %>% 
  rename(target = eez_name,
         end_lon = longitude,
         end_lat = latitude) %>% 
  ungroup() %>% 
  # Plot miscs
  # mutate(
  #   per_mid = ifelse(is.na(per_mid),0,per_mid)
  # ) %>% 
  drop_na() #%>% 
  # filter(
    # per_mid >= 20,
    # variable == "mean_spp",
  # )


# Convert to data to spatial
network_data_sf <- Test_Data %>%
  select(start_lon, start_lat, end_lon, end_lat) %>% 
  purrr::transpose() %>% 
  purrr::map(~ matrix(flatten_dbl(.), nrow = 2, byrow = TRUE)) %>% 
  purrr::map(st_linestring) %>%
  st_sfc(crs = 4326) %>%
  st_sf(geometry = .)%>%
  bind_cols(Test_Data) %>%
  select(everything(), geometry) %>% 
  # Set circles ('cus the world is not flat!)
  st_segmentize(units::set_units(100, km)) %>% 
  mutate(geometry = (geometry + c(180,90)) %% c(360) - c(180,90)) %>% 
  st_wrap_dateline(options = c("WRAPDATELINE=YES",  "DATELINEOFFSET=180"), quiet = TRUE) %>% 
  sf::st_sf(crs = 4326)

#  unpack the coordinates of each feature 
coord_data <- as.data.frame( st_coordinates(st_cast(network_data_sf,"MULTILINESTRING")$geometry))

c(network_data_sf$line_id, network_data_sf$coords) %<-% (
  coord_data %>% 
    rename(subline_id = L1) %>%   
    nest(-L2)
)

# Create data path for line connections
paths <- network_data_sf %>% 
  sf::st_set_geometry(NULL) %>% 
  unnest() %>% 
  mutate_at(vars(X,Y), round,2)

# Plot it!

country <- c("Fiji","Solomon Isl.","Tuvalu")

ggplot() +
  geom_sf(
    # data = subset(world_map,name %in% country),
    data = World_map,
    size = 0.1, fill = "gray90", col = "gray90") +
  geom_sf(
    # data = subset(World_eez_sf, eez_name %in% country),
    data = World_eez_sf,
    size = 0.1, fill = "white", col = "gray70") +
  geom_point(data = Test_Data,
             # data = subset(Test_Data, source %in% country & target %in% source),
             aes(start_lon,
                 start_lat,
                 col = n_tax_emer
                 ),
             size = 0.1,
             col = "grey50",
             # shape = 21,
             stroke = 1.5) +
  geom_path(data = paths,
            # data = subset(paths, source %in% country),
            aes(X, Y,
                group = interaction(line_id,subline_id),
                col = n_tax_emer
            ),
            size = 0.3,
            # arrow = arrow(length = unit(0.009, "npc")),
            show.legend = NA) +
  ggtheme_map() +
  scale_colour_viridis(
    name="Number of emerging stocks\nby 2050",
    limits = c(0,40),
    breaks = seq(0,40,10),
    # option="magma",
    direction = 1
  ) +
  ggsave("./Figures/figure_emerging_2050.png",
         width = 10,
         height = 6,
         units = "in"
  )


```
